let md="---\ngestionGrosMots: true\n---\n# ChatMD\n\nBonjour, je suis ChatMD, un chatbot, que vous pouvez configurer par vous-même en Markdown :\n\n- Créez un fichier en Markdown et mettez-le en ligne : sur CodiMD, ou sur une forge\n- Respectez la syntaxe de ChatMD pour définir votre chatbot\n\nVotre chatbot est alors prêt et visible à l'adresse suivante : [https://chatmd.forge.apps.education.fr/#URL](https://chatmd.forge.apps.education.fr/#URL) (Mettez l'url de votre fichier à la place de URL)\n\n1. [Qu'est-ce que le Markdown ?](Markdown)\n2. [CodiMD, une forge : qu'est-ce que c'est ?](CodiMD et forge)\n3. [Quelle syntaxe faut-il respecter pour ChatMD ?](Syntaxe)\n4. [Tu peux me donner des exemples !](Exemples)\n5. [Quelles sont les options de configuration plus avancées ?](Options de configuration)\n6. [À quoi ça sert ?](À quoi ça sert ?)\n7. [Comment utiliser ChatMD en tant que widget ?](Utilisation sous la forme d'un widget)\n\n## Markdown\n- markdown\nLe Markdown est un format de balisage très léger qui permet d'écrire rapidement du texte formaté.\n\nPour découvrir le Markdown, vous pouvez suivre ce [tutoriel](https://www.markdowntutorial.com/fr/).\n\n## CodiMD et forge\n- codimd\n- codi\n- forge\n- en ligne\n\n[CodiMD](https://codimd.apps.education.fr/) est un outil pour écrire du Markdown en ligne et il est disponible avec vos identifiants académiques sur le [portail Apps Edu](https://portail.apps.education.fr/).\n\nUne forge est un outil plus complet qui permet d'héberger des fichiers texte et de les transformer en site web, en carte mentale, ou encore ici en chatbot ! ChatMD est présent sur la [Forge des Communs Numériques Éducatifs](https://forge.apps.education.fr/) et vous pouvez aussi mettre vos fichiers sur cette forge.\n\n## Syntaxe\n- syntaxe\n- règles\n- comment\n\nLa syntaxe pour écrire un chatbot avec chatMD est la suivante, mais c'est peut-être plus simple de [voir des exemples](#Exemples) ou bien de [récupérer un modèle](https://codimd.apps.education.fr/mBGbHStJSVOSrlGfGb981A?both).\n\n```\n​# Titre du chatbot\n​\nMessage initial\n​\n1​. [Premier choix](Réponse 1)\n2​. [Deuxième choix](Réponse 2)\n​\n​## Réponse 1\n- déclencheur 1 (optionnel)\n- déclencheur 2 (optionnel)\n​\nContenu de la réponse\n​\n1​. [Proposition 1](Titre Proposition 1)\n2​. [Proposition 2](Titre Proposition 2)\n```\n\nDans le message initial et le contenu de chaque réponse, **on peut utiliser toute la syntaxe Markdown** : intégrer des images, des vidéos, des iframes, et même utiliser des balises HTML.\n\nLes **titres de niveau 2** servent à identifier les réponses possibles du chatbot\n\n### Deux manières pour déclencher une réponse\n\n:::info L'utilisateur va devoir cliquer sur des propositions\nOn indique alors en fin d'un message les propositions possibles, avec une liste ordonnée en Markdown.\nChaque élément de la liste doit avoir la forme suivante :\n`[intitulé de l'option qui s'affiche pour l'utilisateur](titre de la réponse correspondante dans le fichier en Markdown)`.\n:::\n\n:::info L'utilisateur va poser une question\nPour permettre au chatbot de renvoyer la réponse la plus adéquate, on indique sous le titre de la réponse les mots clés ou expressions qui vont renforcer le choix de cette réponse. On utilise une liste non ordonnée en Markdown.\n:::\n\nC'est recommandé de combiner ces 2 options pour être sûr que l'utilisateur trouve les réponses à ses questions !\n\n\n\n1. [Voir aussi les options de configuration plus avancées](Options de configuration)\n\n## Options de configuration\n- yaml\n- en-tête\n- en-tête yaml\n- options\n- avancé\n- avatar\n- mathématiques\n- gros mots\n- insulte\n- style\n- apparence\n\nOn peut ajouter un en-tête yaml à son fichier Markdown :\n\n- `clavier: false` désactive le champ d'entrée clavier si on souhaite simplement guider l'utilisateur avec les options proposées en fin de chaque réponse.\n- `rechercheContenu: true` permet d'ajouter une recherche de comparaison de l'entrée de l'utilisateur avec le contenu de chaque réponse\n- `style: a{color:red}` permet d'ajouter des styles CSS personnalisés.\n- `gestionGrosMots: true` permet de détecter les gros mots envoyés par l'utilisateur et de formuler une réponse adéquate si l'utilisateur en utilise\n- `maths: true` permet d'écrire des formules mathématiques en Latex avec la syntaxe `$Latex$` ou `$$Latex$$`\n- `avatar: URL` permet de changer l'avatar du chatbot (il faut mettre l'url de son image à la place de URL)\n- `footer: false` permet de supprimer le footer\n- `theme: bubbles` permet d'utiliser un thème CSS particulier (ici le thème \"bubbles\")\n\nLe chatbot peut aussi sélectionner de manière aléatoire plusieurs versions d'une même réponse si on sépare ces différentes versions avec le séparateur `-​-​-`.\n\nOn peut également afficher les propositions en fin de message de manière aléatoire : si on met \"1. proposition\" : la proposition reste à la place indiquée, alors que si on met \"1) proposition\" : la proposition est réordonnée de manière aléatoire.\n\nD'autres options plus avancées dans l'en-tête yaml :\n- `messageParDéfaut: [\"message 1\", \"message 2\", \"message 3\"]` permet de modifier le message par défaut qui s'affiche aléatoirement quand le chatbot n'a pas trouvé de réponse pertinente \n- `titresRéponses: [\"### \", \"#### \"]` permet de changer les identifiants possibles des réponses du chatbot si on veut pouvoir structurer les réponses du chatbot dans son document\n- On peut aussi définir des variables que l'on peut utiliser dans son chatbot ainsi : &#64;{maVariable1}\n```\nvariables:\n\tmaVariable1: \"Ceci est ma variable 1\"\n\tmaVariable2: \"Ceci est ma variable 2\"\n```\n\n## Exemples\n- exemple\n- donner un exemple\n- concret\n- concrètement\n- modèle\n- template\n\nVoici un modèle que vous pouvez récupérer pour construire votre chatbot : [modèle à récupérer](https://codimd.apps.education.fr/mBGbHStJSVOSrlGfGb981A?both)\n\nVoici quelques exemple de chatbot créés avec ChatMD : \n\n- [Méthode de la dissertation en philosophie](https://chatmd.forge.apps.education.fr/#https://eyssette.forge.apps.education.fr/chatbot/dissertation-philosophie.md)\n- [Utilisation d'un microscope](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/xGNHIJSeTVCk6FHas-_71g) : un chatbot créé à partir du travail de  Sylvain Tissier, Guillaume Berthelot et de Jérémy Navoizat [voir la source](https://codimd.apps.education.fr/xGNHIJSeTVCk6FHas-_71g?both)\n\n## À quoi ça sert ?\n- à quoi ça sert ?\n- pourquoi\n- sert\n- intérêt\n- servir\n- objectif\n- but\n- en faire\n- tutoriel\n- histoire\n- méthod\n- révision\n- utilité\n- utile\n\nOn peut imaginer plusieurs usages de chatMD :\n- Tutoriel pour un outil informatique\n- Histoire dont vous êtes le héros\n- Guide méthodologique\n- Soutien pour la révision d'un cours\n- Discussion avec un personnage historique …\n\nOn peut faire travailler des élèves ensemble sur un CodiMD, ou bien travailler collaborativement entre collègues, en tant que prof ou dans le cadre d'une formation.\n\nSi vous avez trouvé des idées intéressantes, n'hésitez pas à les partager avec moi. Vous pouvez me contacter sur [Mastodon](https://scholar.social/@eyssette).\n\n## Utilisation sous la forme d'un widget\n- widget\n- dans son site\n- dans mon site\n- intégrer\n- intégration\n\nVous pouvez intégrer chatMD dans une page HTML en insérant ce code en bas de page dans l'élément ```body```.\n\n```js\n<script id=\"chatmdWidgetScript\"\nsrc=\"https://chatmd.forge.apps.education.fr/widget.min.js\" \ndata-chatbot=\"URL_SOURCE_CHATBOT\"><\/script>\n```\n\nIl faut bien sûr remplacer ```URL_SOURCE_CHATBOT``` par l'URL de la source de votre chatbot.\n\nOn peut customiser l'image du widget en ajoutant `data-image=\"URL_IMAGE\"` comme paramètre.\n\n## Merci\n- merci\n- remercier\n- remercie\n- félicitations\n- félicit\n- bravo\n- super\n- excellent\n- génial\n- wow\n- chouette\n- sympa\n- cool\n\nMerci ! Si vous aimez ce travail, vous aimerez peut-être aussi les autres outils ou sites que je propose sur [mon site perso](https://eyssette.forge.apps.education.fr).\n\n\n",defaultMessage=["Désolé, je ne comprends pas votre question.","Pardonnez-moi, mais je ne saisis pas votre demande.","Excusez-moi, je ne parviens pas à comprendre ce que vous demandez.","Je suis navré, mais je ne parviens pas à saisir votre question.","Malheureusement, je ne suis pas en mesure de comprendre votre question.","Je suis désolé, mais je ne saisis pas votre question.","Pardonnez-moi, mais je ne saisis pas le sens de votre question.","Je m'excuse, mais je ne parviens pas à saisir votre demande. Pouvez-vous reformuler votre question, s'il vous plaît ?","Je ne suis pas sûr de comprendre ce que vous demandez. Pouvez-vous expliquer davantage ?","Je ne peux pas répondre à votre question telle qu'elle est formulée. Pouvez-vous la poser différemment ?","Votre question ne semble pas correspondre à mes capacités actuelles. Pourriez-vous la reformuler autrement ?","Je n'ai malheureusement pas compris votre requête.","Je suis désolé, je ne suis pas capable de répondre.","Malheureusement, je ne peux pas répondre à votre question.","Malheureusement je n'arrive pas à comprendre votre requête.","Excusez-moi, je ne comprends pas votre requête.","Excusez-moi, je n'arrive pas à répondre à votre question.","Je ne parviens pas à répondre à votre requête. Veuillez m'excuser."];const badWordsMessage=["Même si je ne suis qu'un chatbot, merci de vous adresser à moi avec un langage approprié","Je préférerais que nous restions courtois dans notre communication.","Les insultes ne sont pas nécessaires. Comment puis-je vous aider autrement ?","Essayons de garder une conversation respectueuse.","Je préfère une conversation respectueuse et productive.","Je vous encourage à reformuler votre question ou commentaire de manière respectueuse.","Les mots offensants ne sont pas nécessaires ici. Comment puis-je vous aider de manière constructive ?","Restons courtois dans nos échanges, s'il vous plaît.","Injures et grossièretés ne mènent nulle part. Comment puis-je vous assister ?","Je suis ouvert à la discussion, mais veuillez garder un langage respectueux.","Essayons de communiquer de manière civilisée !"],shortcuts=[["dissertation-philo","https://raw.githubusercontent.com/eyssette/chatbot/main/dissertation-philosophie.md"]],corsProxy="https://corsproxy.io/?",allowedAddOns={pako:{js:"scripts/pako.min.js"},kroki:{js:"scripts/kroki.js"},textFit:{js:"scripts/textFit.min.js",css:"<style>.katex-display{max-width:80%} .katex-display .textFitted{white-space:nowrap}</style>"}},addOnsDependencies={kroki:["pako"]};let yamlUseAddOns,yamlUseLLMurl,yamlUseLLMmodel,yamlStyle="",yamlUserInput=!0,yamlSearchInContent=!1,yamldetectBadWords=!1,yamlMaths=!1,yamlFooter=!0,yamlTheme="",yamlDynamicContent=!1,yamlTypeWriter=!0,yamlObfuscate=!1,yamlUseLLMapiKey="",yamlUseLLMalways=!1;const defaultMaxTokens=100,defaultSystemPrompt="Tu es un assistant efficace qui réponds en français et pas dans une autre langue. Les phrases de réponse doivent être courtes et claires.",defaultPostprompt="\nN'oublie pas de répondre en français.";let yamlUseLLMsystemPrompt=defaultSystemPrompt,yamlUseLLMmaxTokens=defaultMaxTokens,yamlUseLLMinformations="",yamlUseLLMpreprompt="",yamlUseLLMpostprompt=defaultPostprompt;const defaultRAGprompt="\nVoici ci-dessous le contexte à partir duquel tu dois partir pour construire ta réponse, tu dois sélectionner dans ce contexte l'information pertinente et ne pas parler du reste. Si l'information n'est pas dans le contexte, indique-le et essaie de répondre malgré tout.\nCONTEXTE : ",defaultRAGpromptStrict="\nVoici ci-dessous le contexte à partir duquel tu dois construire ta réponse, tu dois sélectionner dans ce contexte l'information pertinente et ne pas parler du reste. Si la réponse à la question n'est pas dans le contexte, tu ne dois pas répondre et dire : je ne sais pas. \nCONTEXTE : ";let chatData,filterBadWords,yamlUseLLM,yamlUseLLMragSeparator="\n",yamlUseLLMmaxTopElements=3,yamlUseLLMragPrompt=defaultRAGprompt;function createChatBot(e){const t={},n={...Object.fromEntries(new URLSearchParams(document.location.search)),...Object.fromEntries(new URLSearchParams(document.location.hash.replace(/#.*\?/,"")))};for(const[e,s]of Object.entries(n))t["GET"+e]=s;let s="",a=!1,r=0;const o=3;let i="",l=!1,c="";const u=document.getElementById("footer"),d=document.getElementById("controls");if(!1===yamlFooter){u.style.display="none",d.style.height="70px";const e="@media screen and (max-width: 500px) { #controls {height:110px!important}}",t=document.createElement("style");t.innerText=e,document.head.appendChild(t)}const p=e.pop();let m=e.pop();document.getElementById("chatbot-name").textContent=p;const f=document.getElementById("chat"),h=document.getElementById("user-input"),y=document.getElementById("send-button");let g=null,L=Math.floor(Math.random()*defaultMessage.length),v=[];function M(){setTimeout((()=>{window.scrollTo(0,document.body.scrollHeight)}),100)}const b=new showdown.Converter({emoji:!0,parseImgDimensions:!0,simpleLineBreaks:!0,simplifiedAutoLink:!0,tables:!0,openLinksInNewWindow:!0,extensions:[function(){return[{type:"output",filter:e=>{const t=(e=e.replaceAll("<p>:::",":::")).match(/:::(.*?)\n(.*?):::/gs);if(t){let n=e;for(const s of t){const t=/:::(.*?)\s(.*?)\n(.*?):::/s.exec(s),a=e.indexOf(s);if(!("<code>"==e.substring(a-6,a))){let e=t[1],a=t[2];e.includes("<br")&&(e=e.replace("<br",""),a="");const r=t[3];a.includes("collapsible")?(a=a.replace("collapsible",""),matchReplaced=`<div><div class="admonition ${e}"><details><summary class="admonitionTitle">${a}</summary><div class="admonitionContent">${r}</div></details></div></div>`):matchReplaced=`<div><div class="admonition ${e}"><div class="admonitionTitle">${a}</div><div class="admonitionContent">${r}</div></div></div>`,n=n.replaceAll(s,matchReplaced)}}return n}return e}}]}]});function x(e){return e[Math.floor(Math.random()*e.length)]}const w=document.getElementById("chat"),A=!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);let U;const C="^300 ",E=800;function k(e,t,n){f.appendChild(n),t||window.matchMedia("(prefers-reduced-motion: reduce)").matches||!1===yamlTypeWriter?n.innerHTML=e:function(e,t){const n=window.innerWidth>880?"Appuyez sur “Enter” pour stopper l'effet “machine à écrire” et afficher la réponse immédiatement":"“Enter” pour stopper l'effet “machine à écrire”";function s(e){U.stop(),U.reset();const t=(e=(e=e.replaceAll(/`(<span class="katex-mathml">(.|\n)*?<\/span>)`/gm,"$1")).replaceAll(/`(<span class=".?strut">.*?<\/span>)`/g,"$1")).replaceAll(/(<pre(.|\n)*<\/pre>)/gm,(function(e){return e.replaceAll("\n","RETURNCHARACTER")})).split("\n").map((e=>e.startsWith(C)?e.replace(C,"").replaceAll("RETURNCHARACTER","\n")+"`":e.endsWith("`")?"`"+e.replaceAll("RETURNCHARACTER","\n"):"`"+e.replaceAll("RETURNCHARACTER","\n")+"`"));U.strings=[t.join(" ")],U.start(),U.destroy()}let a;function r(t){"Enter"===t.key&&(a.disconnect(),l=!1,s(e))}let o=0;const i=Date.now();let l=!0;function c(){const t=Date.now()-i;50==o&&t>E&&l&&(s(e),l=!1,a.disconnect()),M(),o++}const u={childList:!0,subtree:!0};e=e.replace(/(<ul class="messageOptions"\>[\s\S]*<\/ul>)/gm,C+"`$1`"),U=new Typed(t,{strings:[e],typeSpeed:-5e3,startDelay:100,showCursor:!1,onBegin:()=>{function e(){a.observe(w,u)}A&&h.focus(),h.addEventListener("keypress",r),h.setAttribute("placeholder",n),a=new MutationObserver(c),e(),setTimeout((()=>{document.addEventListener("mousemove",(function(){l=!1,a.disconnect()})),document.addEventListener("wheel",(function(t){t.deltaY>0&&window.scrollY+window.innerHeight>=document.body.offsetHeight?e():(l=!1,a.disconnect())})),document.addEventListener("touchstart",(function(){l=!1,a.disconnect(),setTimeout((()=>{window.scrollY+window.innerHeight+200>=document.documentElement.scrollHeight&&e()}),5e3)}))}),1e3)},onComplete:()=>{yamlUseAddOns&&yamlUseAddOns.includes("textFit")&&textFit(t.querySelectorAll(".katex-display")),h.removeEventListener("keypress",r),h.getAttribute("placeholder")==n&&h.setAttribute("placeholder","Écrivez votre message"),a.disconnect()}})}(e,n)}function O(e,n){const u=document.createElement("div");let d;if(u.classList.add("message"),u.classList.add(n?"user-message":"bot-message"),e=e.replace(/@{(\S+)}/g,(function(e,t){return yamlData&&yamlData.variables&&yamlData.variables[t]?x(yamlData.variables[t].split("///")):"@{"+t+"}"})),!n){const t=e.split("\n---\n");if(t.length>1){const n=e.indexOf('<ul class="messageOptions">');if(n>-1){const t=e.substring(0,n),s=e.substring(n),a=t.split("---");e=x(a)+s}else e=x(t)}e=(e=(e=(e=e.replaceAll(/<audio[\s\S]*?src="([^"]+)"[\s\S]*?<\/audio>/gm,(function(e,t){if(e.includes("autoplay")){return new Audio(t).play(),`\x3c!--${e}--\x3e`}return e}))).replaceAll(/!Audio:(.*)/g,(function(e,t){return new Audio(t.trim()).play(),""}))).replaceAll(/!Next ?:(.*)/g,(function(t,n){const l=n.split("/");let u;if(l.length>0?(n=l[0],u=l[1]):n=l[0],t&&r<o)return c=e,s=n.trim(),a=!0,i=u?u.trim():"Ce n'était pas la bonne réponse, merci de réessayer !",i+="\n\n",r++,"\x3c!----\x3e";{c="";const e=s;if(s="",a=!1,r==o){r=0;return`<ul class="messageOptions"><li><a href="#${yamlObfuscate?btoa(e):e}">Passer à la suite !</a></li></ul>`}}}))).replaceAll(/!SelectNext:(.*)/g,(function(e,t){if(e){const e=t.split("/");return c="",s="",a=!1,d=x(e).trim(),""}d=void 0})),yamlUseAddOns&&yamlUseAddOns.includes("kroki")&&(e=e.replaceAll(/```(mermaid|tikz|graphviz|plantuml|excalidraw|vegalite|vega)((.|\n)*?)```/gm,(function(e,t,n){return n=n.replaceAll("\n\n\n","\n\n"),krokiCreateImageFromSource(t,n)})))}yamlDynamicContent&&(n?(e=e.replaceAll(/@([^\s]*?)\=(.*)/g,(function(e,n,s,a){return t[n]=s,0==a?s:""})),l?l&&l.length>0?(t[l[0]]=e,s=l[1],l=!1):s="":s=a?s:""):(e=(e=(e=(e=(e=e.replaceAll(/\`@([^\s]*?) ?= ?(?<!@)(.*?)\`/g,(function(e,n,s){return e.includes("calc(")||e.includes("@INPUT")?e:(t[n]=s,"")}))).replaceAll(/\`@([^\s]*?)\`/g,(function(e,n){return e.includes("=")?e:t[n]?t[n]:e}))).replaceAll(/\`@([^\s]*?) ?= ?calc\((.*)\)\`/g,(function(e,n,s){return calc=s.replace(/@(\w+)/g,((e,n)=>t[n]||e)),t[n]=calc,""}))).replaceAll(/\`@([^\s]*?)\`/g,(function(e,n){return e.includes("=")?e:t[n]?t[n]:""}))).replaceAll(/\`@([^\s]*?) ?= ?@INPUT : (.*)\`/g,(function(e,t,n){return l=!!e&&[t,n],""})),!1===yamlUserInput?"true"==t.KEYBOARD?(document.body.classList.remove("hideControls"),t.KEYBOARD="false"):document.body.classList.add("hideControls"):"false"==t.KEYBOARD?(document.body.classList.add("hideControls"),t.KEYBOARD="true"):document.body.classList.remove("hideControls"),e=(e=(e=e.replaceAll(/ (@[^\s]*?\=.*?)\</g,'<span class="hidden">$1</span><')).replaceAll(/>(@[^\s]*?\=)/g,'><span class="hidden">$1</span>')).replaceAll(/\`if (.*?)\`((\n|.*)*?)\`endif\`/g,(function(e,n,s){if(!n)return"";try{n=(n=n.replace(/@([^\s()&|!=]+)/g,(function(e,t){return'customVariables["'+t.trim()+'"]'}))).replaceAll(/(==|!=|<|>) ?(.*?) ?(\)|\&|\||$)/g,(function(e,t,n,s){return`${t}"${n}" ${s}`})).replaceAll('""','"').replace('"undefined"',"undefined");if(/^(\s*(!|\(|\)|&&|\|\||==|!=|===|!==|<=|>=|<|>|true|false|null|undefined|[0-9]+|[+-]?([0-9]*[.])?[0-9]+|"[^"]*"|'[^']*'|`[^`]*`|[a-zA-Z0-9_]+\[[^\]]+\]|\s+))*\s*$/.test(n)){return new Function("customVariables","return "+n)(t)?s:""}throw new Error("Invalid expression")}catch(e){return console.error("Error evaluating condition:",n,e),"\x3c!--"+n+"--\x3e"}})),e=e.replaceAll(/\n\n\n*/g,"\n\n")));let p=(m=(m=e).replaceAll("\n\n|","|"),b.makeHtml(m));var m;!0===yamlMaths?(p=function(e){let t=(e=e.replace(/\$\$(.*?)\$\$/g,"&#92;[$1&#92;]").replace(/\$(.*?)\$/g,"&#92;($1&#92;)")).match(new RegExp(/&#92;\[.*?&#92;\]|&#92;\(.*?&#92;\)/g));if(t)for(let n of t){const t=!!n.includes("&#92;[");let s=n.replace("&#92;[","").replace("&#92;]","");s=s.replace("&#92;(","").replace("&#92;)",""),s=s.replaceAll("&lt;","\\lt").replaceAll("&gt;","\\gt"),stringWithLatex=katex.renderToString(s,{displayMode:t}),e=e.replace(n,stringWithLatex)}return e}(p),p=p.replaceAll(/(<span class="katex-mathml">(.|\n)*?<\/span>)/gm,"`$1`"),p=p.replaceAll(/(<span class=".?strut">.*?<\/span>)/g,"`$1`"),setTimeout((()=>{k(p,n,u)}),100)):k(p,n,u),d&&G(d)}function q(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;const n=[];for(let e=0;e<=t.length;e++)n[e]=[e];for(let t=0;t<=e.length;t++)n[0][t]=t;for(let s=1;s<=t.length;s++)for(let a=1;a<=e.length;a++){const r=e[a-1]===t[s-1]?0:1;n[s][a]=Math.min(n[s-1][a]+1,n[s][a-1]+1,n[s-1][a-1]+r)}return n[t.length][e.length]}function D(e,t,n){const s=e.split(" ");for(const e of s){if(q(e,t)<n)return!0}return!1}const R=3,S=5,T=.55;function j(t){if(""!=t)for(let n=0;n<e.length;n++){let s=e[n][0];if(s=yamlObfuscate?btoa(s):s,t==s){let t=e[n][2];const s=e[n][3];t=Array.isArray(t)?t.join("\n\n"):t,g=s,t=s?V(t,s):t,O(t,!1);break}}else O(m,!1)}function P(e){const t={"à":"a","â":"a","é":"e","è":"e","ê":"e","ë":"e","î":"i","ï":"i","ô":"o","ö":"o","û":"u","ü":"u","ÿ":"y","ç":"c","À":"A","Â":"A","É":"E","È":"E","Ê":"E","Ë":"E","Î":"I","Ï":"I","Ô":"O","Ö":"O","Û":"U","Ü":"U","Ÿ":"Y","Ç":"C"};return e.replace(/[àâéèêëîïôöûüÿçÀÂÉÈÊËÎÏÔÖÛÜŸÇ]/g,(e=>t[e]||e))}function $(t,n){const a=function(t,n){let a=t.toLowerCase();a=a.replace(/,|\.|\:|\?|\!|\(|\)|\[|\||\/\]/g,""),a=a.replaceAll("/"," "),a=P(a),a=a.split(/\s|'/).map((e=>e.trim())).filter((e=>e.length>=5))||[];const r=[],o=[0,0,0,0,.4,.6,.8],i=s?100:10;function l(t,s,a){let r=o[s-1];r=0===t?r+.2:r;const l=a.substring(t,t+s);return n&&e[n][0].toLowerCase().includes(l)&&(r+=i),{token:l,weight:r}}for(let e=0;e<a.length;e++){const t=a[e];r.push({token:t,weight:5});const n=t.length;if(n>=5)for(let e=0;e<=n-5;e++)r.push(l(e,5,t));if(n>=6)for(let e=0;e<=n-6;e++)r.push(l(e,6,t));if(n>=7)for(let e=0;e<=n-7;e++)r.push(l(e,7,t))}return r}(t,n),r={};for(const{token:e,weight:t}of a)e&&(r[e]=(r[e]||0)+t);return r}let W=[];if(yamlSearchInContent||yamlUseLLM)for(let t=0;t<e.length;t++){const n=e[t][2];let s=Array.isArray(n)?n.join(" ").toLowerCase():n.toLowerCase();s=e[t][0]+" "+s;const a=$(s,t);W.push(a)}let I=[];function z(e){if(e)for(let t=0;t<e.length;t++){const n=$(e[t]);I.push(n)}}function B(e,t){function n(e){let t=0;for(const n in e)t+=e[n]**2;return Math.sqrt(t)}const s=$(e),a=function(e,t){const n=new Set([...Object.keys(e),...Object.keys(t)]);let s=0;for(const a of n)s+=(e[a]||0)*(t[a]||0);return s}(s,t),r=n(s),o=n(t);return 0===r||0===o?0:a/(r*o)}function G(t){""==s||a||(t=s);let n,r="";if(yamlUseLLM&&(t=t.replace('<span class="hidden">!useLLM</span>',"!useLLM"),n=t.trim().replace("!useLLM",""),yamlUseLLMinformations)){const e=function(e,t){let n;return n=e.length<t?e.map(((e,t)=>[e,t])):e.reduce(((e,n,s)=>(e.length<t?(e.push([n,s]),e.sort(((e,t)=>e[0]-t[0]))):n>e[0][0]&&(e[0]=[n,s],e.sort(((e,t)=>e[0]-t[0]))),e)),[]),n.sort(((e,t)=>t[0]-e[0])),n}(I.map((e=>B(n,e))),yamlUseLLMmaxTopElements);r=e.map((e=>yamlUseLLMinformations[e[1]])).join("\n")}if(!0===yamldetectBadWords&&filterBadWords&&filterBadWords.check(t))return void O(x(badWordsMessage),!1);let o,l,u,d=null,p=0,m=0,f=t.toLowerCase();if(g&&(l=g.map((e=>e[0].toLowerCase())),u=l.indexOf(f)),g&&u>-1){j(g[u][1])}else{for(let t=0;t<e.length;t++){const n=e[t][0],r=e[t][1];if(a&&n!=s)continue;a&&n==s&&0==r.length&&(f=s.toLowerCase());const i=r.concat(n),l=e[t][2];let c=0,u=0;if(yamlSearchInContent){c=c+B(f,W[t])+.5}for(let e of i){let t=e.toLowerCase();if(f.includes(t)){let e=!1;if(a){f=P(f),t=P(t);const n=new RegExp(`\\b${t}\\b`);f.match(n)&&(e=!0)}else e=!0;e&&(c+=S,c+=t.length/10)}else f.length>4&&D(f,e,R)&&u++}0!=c||a||u>m&&(c++,m=u),c>0&&a&&n==s&&(c+=S),c>p&&(d=l,p=c,o=t)}if(d&&p>T||a){d&&a&&(c="",s="",a=!1);let l=d?Array.isArray(d)?d.join("\n\n"):d:"";const u=d?e[o][0]:"";let p=d?e[o][3]:[];if(selectedResponseWithOptions=a&&u!==s?c.includes(i)?c:i+c:V(l,p),yamlUseLLM&&yamlUseLLMurl&&yamlUseLLMmodel&&yamlUseLLMalways||t.includes("!useLLM"))return void getAnswerFromLLM(n.trim(),l+"\n"+r);O(selectedResponseWithOptions,!1)}else{if(yamlUseLLM&&yamlUseLLMurl&&yamlUseLLMmodel&&yamlUseLLMalways||t.includes("!useLLM"))return void getAnswerFromLLM(n,r);{for(;v.includes(L);)L=Math.floor(Math.random()*defaultMessage.length);v.length>4&&v.shift(),v.push(L);let e=defaultMessage[L];if(yamlUseLLM&&!yamlUseLLMalways&&yamlUseLLMurl&&yamlUseLLMmodel){e=V(e,[["Voir une réponse générée par une IA","!useLLM "+t]])}O(e,!1)}}}}function H(e){return e.sort((function(){return Math.random()-.5}))}function V(e,n){if(yamlDynamicContent&&Object.keys(t).length>0&&n&&(n=n.filter((e=>{for(const[n,s]of Object.entries(t)){if(!e[3])return!0;if(e[3]&&e[3].includes(`@${n}`))return e[3]===`@${n}==${s}`}}))),e=e.replaceAll(/\!Select ?: ?([0-9]*)/g,(function(e,t){return e&&t<=n.length?(n=H(n).slice(0,t),"\x3c!--"+e+"--\x3e"):""})),function(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)if(!0===e[t][2])return!0;return!1}(n)&&(n=function(e){let t=[],n=[];e.forEach((function(e){e[2]?n.push(e):t.push(e)})),n=H(n);var s=[];return e.forEach((function(e){e[2]?s.push(n.shift()):s.push(e)})),s}(n)),n){g=n;let t='\n<ul class="messageOptions">';for(let e=0;e<n.length;e++){const s=n[e],a=s[0];t=t+'<li><a href="#'+s[1]+'">'+a+"</a></li>\n"}t+="</ul>",e+=t}else g=null;return e}window.useLLMpromise&&window.useLLMpromise.then((()=>{window.useLLMragContentPromise?window.useLLMragContentPromise.then((()=>{z(yamlUseLLMinformations)})):z(yamlUseLLMinformations)})).catch((e=>{console.error("Erreur d'accès aux données RAG : ",e)})),y.addEventListener("click",(()=>{const e=h.innerText;""!==e.trim()&&(O(e,!0),setTimeout((()=>{G(e),M()}),100),h.innerText="")})),document.addEventListener("keypress",(e=>{h.focus(),"Enter"===e.key?(e.preventDefault(),y.click(),M()):h.parentElement.parentElement.classList.contains("hideControls")&&e.preventDefault()})),h.focus({preventScroll:!0}),h.addEventListener("focus",(function(){this.classList.remove("placeholder")})),h.addEventListener("blur",(function(){this.classList.add("placeholder")})),f.addEventListener("click",(e=>function(e){const t=e.target;if("A"===t.tagName){const n=window.location.href,s=t.getAttribute("href");if(s.startsWith(n)&&window.open(s),s.startsWith("#")){e.preventDefault();let n=t.innerText;const a=yamlObfuscate?atob(s.replace("#","")):s;yamlUseLLM&&yamlUseLLMurl&&yamlUseLLMmodel&&a.includes("!useLLM")?(n=a.replace("#","").replace("!useLLM",'<span class="hidden">!useLLM</span>').trim(),O(n,!0),G(n)):(O(n,!0),j(s.substring(1)),document.activeElement.blur(),A&&h.focus()),M()}}}(e))),m=V(m[0].join("\n"),m[1]),O(m,!1),m=m.replace(/<span class=\"unique\">.*?<\/span>/,"")}const controls=document.getElementById("controls");function handleURL(e){if(""!==e){let t=!0;const n=shortcuts.find((t=>t[0]==e));n&&(e=n[1]),e.includes(".forge")&&(t=!1),e.startsWith("https://github.com")&&(t=!1,e=(e=e.replace("https://github.com","https://raw.githubusercontent.com")).replace("/blob/","/")),(e.startsWith("https://codimd")||e.includes("hedgedoc")||e.includes("digipage"))&&(t=!1,e=-1===(e=e.replace("?edit","").replace("?both","").replace("?view","").replace(/#$/,"").replace(/\/$/,"")).indexOf("download")?e+"/download":e),e.includes("framapad")&&!e.endsWith("/export/txt")&&(e=e.replace(/\?.*/,"")+"/export/txt"),e=t?corsProxy+e:e}return e}function getMarkdownContent(){const e=window.location.hash.substring(1).replace(/\?.*/,"");if(""!==e){const t=handleURL(e);fetch(t).then((e=>e.text())).then((e=>{md=e,chatData=parseMarkdown(md),createChatBot(chatData)})).catch((e=>console.error(e)))}else createChatBot(parseMarkdown(md))}function loadScript(e){return new Promise(((t,n)=>{const s=document.createElement("script");s.src=e,s.onload=t,s.onerror=n,document.head.appendChild(s)}))}function loadCSS(e){return new Promise(((t,n)=>{let s;e.startsWith("<style>")?(s=document.createElement("style"),s.textContent=e.replace("<style>","").replace("</style>","")):(s=document.createElement("link"),s.href=e,s.rel="stylesheet",s.onload=t,s.onerror=n),document.head.appendChild(s)}))}function startsWithAnyOf(e,t){for(const n of t)if(e.startsWith(n))return n}let yamlData;function prepareRAGdata(e,t){if(t){if("auto"==t){return function(e,t=600){let n=[],s=0;for(;s<e.length;){let a=s+t;if(a<e.length){let t=e.lastIndexOf(" ",a);t>s&&(a=t)}n.push(e.slice(s,a).trim()),s=a+1}return n}(e)}return"break"==yamlUseLLM.separator?e.split("---").map((e=>e.replaceAll("\n"," ").trim())):e.split(yamlUseLLM.separator)}return e.split("\n").filter((e=>""!==e.trim()))}async function getRAGcontent(e){if(e){if(yamlUseLLMmaxTopElements=yamlUseLLM.maxTopElements?yamlUseLLM.maxTopElements:3,!e.includes("http"))return e.toString().includes("useFile")?(RAGinformations=RAGinformations.trim(),yamlUseLLMinformations=prepareRAGdata(RAGinformations,yamlUseLLM.separator)):(RAGinformations=e.trim(),yamlUseLLMinformations=prepareRAGdata(RAGinformations,yamlUseLLM.separator)),yamlUseLLMinformations;{const t=handleURL(e);yamlUseLLMinformations=await fetch(t).then((e=>e.text())).then((e=>prepareRAGdata(e,yamlUseLLM.separator)))}}}function parseMarkdown(e){let t=["## "];if(e.split("---").length>2&&e.startsWith("---"))try{yamlData=jsyaml.load(e.split("---")[1]),yamlData.maths&&(yamlData.addOns=yamlData.addOns?yamlData.addOns+",textFit":"textFit");for(const e in yamlData){if("maths"==e&&(yamlMaths=yamlData[e],!0===yamlMaths&&Promise.all([loadScript("https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"),loadCSS("https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css")])),"addOns"==e){yamlUseAddOns=yamlData[e].replace(" ","").split(",");let t=[];for(const[e,n]of Object.entries(addOnsDependencies))if(yamlUseAddOns.includes(e))for(const e of n)t.push(e);yamlUseAddOns.push(...t);for(const e of yamlUseAddOns){const t=[],n=allowedAddOns[e];n&&(n.js&&t.push(loadScript(n.js)),n.css&&t.push(loadCSS(n.css)),Promise.all(t))}}if("titresRéponses"!=e&&"responsesTitles"!=e||(t=yamlData[e],"string"==typeof t&&(t=[t])),"style"==e){yamlStyle=yamlData[e];const t=document.createElement("style");t.innerHTML=yamlStyle,document.body.appendChild(t)}if("userInput"!=e&&"clavier"!=e&&"keyboard"!=e||(yamlUserInput=yamlData[e],!1===yamlUserInput&&document.body.classList.add("hideControls")),"searchInContent"!=e&&"rechercheContenu"!=e||(yamlSearchInContent=yamlData[e]),"gestionGrosMots"!=e&&"detectBadWords"!=e||(yamldetectBadWords=yamlData[e],!0===yamldetectBadWords&&Promise.all([loadScript("scripts/leo-profanity.js"),loadScript("badWords-fr.js")]).then((()=>{filterBadWords=LeoProfanity,filterBadWords.add(badWordsFR)})).catch((e=>{console.error("Une erreur s'est produite lors du chargement des scripts :",e)}))),"avatar"==e){yamlAvatar=yamlData[e];const t=`\n  \t\t\t\t\t\t.bot-message > :first-child:before {\n        \t\t\t\tbackground-image: url("${yamlAvatar}");\n\t\t\t\t\t`,n=document.createElement("style");n.textContent=t,document.head.appendChild(n)}if("defaultMessage"==e||"messageParDéfaut"==e)for(yamlDefaultMessage=yamlData[e],defaultMessage=yamlDefaultMessage;defaultMessage.length<5;)defaultMessage.push(...defaultMessage);if("footer"==e&&(yamlFooter=yamlData[e]),"theme"==e){yamlTheme=yamlData[e];loadCSS(yamlTheme.endsWith(".css")?"themes/"+yamlTheme:"themes/"+yamlTheme+".css")}"dynamicContent"!=e&&"contenuDynamique"!=e||(yamlDynamicContent=yamlData[e]),"typeWriter"!=e&&"effetDactylo"!=e||(yamlTypeWriter=yamlData[e]),"obfuscate"==e&&(yamlObfuscate=!!yamlData[e]),"useLLM"!=e&&"utiliserLLM"!=e||(window.useLLMpromise=Promise.all([loadScript("useLLM.js"),loadScript("RAG.js")]).then((()=>{window.useLLMragContentPromise=new Promise(((e,t)=>{try{e(getRAGcontent(yamlUseLLM.informations))}catch(e){t(e)}}))})).catch((e=>console.error(e))),yamlUseLLM=yamlData[e],yamlUseLLMurl=yamlUseLLM.url,yamlUseLLMapiKey=!0===yamlUseLLM.askAPIkey?prompt("Ce chatbot peut se connecter à une IA pour enrichir les réponses proposées. Entrez votre clé API, puis cliquez sur “OK” pour pouvoir bénéficier de cette fonctionnalité. Sinon, cliquez sur “Annuler”."):"",yamlUseLLMmodel=yamlUseLLM.model,yamlUseLLMalways=yamlUseLLM.always,yamlUseLLMsystemPrompt=yamlUseLLM.systemPrompt?yamlUseLLM.systemPrompt:defaultSystemPrompt,yamlUseLLMpostprompt=yamlUseLLM.postprompt?yamlUseLLM.postprompt:defaultPostprompt,yamlUseLLMpreprompt=yamlUseLLM.preprompt?yamlUseLLM.preprompt:"",yamlUseLLMmaxTokens=yamlUseLLM.maxTokens?yamlUseLLM.maxTokens:defaultMaxTokens)}}catch(e){}let n=[],s=null,a=[],r=[],o=null;const i=/^\d{1,3}(\.|\))\s\[/,l=/^\d{1,3}\)/,c=/\`if (.*?)\`/;let u=!1,d=[],p=[],m=!1,f=e.indexOf("# ");const h=e.indexOf("## ");h>-1&&h==f-1&&(f=0);const y=e.substring(f),g=y.substring(1),L=["# ","## ","### ","#### ","##### "].map((e=>g.indexOf(e))).filter((e=>e>0)),v=Math.min(...L),M=y.substring(0,v),b=M.match(/# .*/),x=b?b[0]:"Chatbot",w=x?[x.replace("# ","").trim()]:[""],A=M.indexOf(x),U=(b?M.substring(A+x.length):M.substring(A)).split("\n");for(let e of U)if(e=e.replace(/^>\s?/,"").trim(),e.match(i)){m=l.test(e);const t=e.replace(/^\d+(\.|\))\s/,"").trim();let n=t.replace(/^\[.*?\]\(/,"").replace(/\)$/,"");n=yamlObfuscate?btoa(n):n;const s=t.replace(/\]\(.*/,"").replace(/^\[/,"");p.push([s,n,m])}else d.push(e);const C=y.substring(v).split("\n");let E="";for(let e of C)if(startsWithAnyOf(e,t))s&&n.push([s,a,r,o]),s=e.replace(startsWithAnyOf(e,t),"").trim(),a=[],o=null,u=!1,r=[];else if(e.startsWith("- ")&&!u)a.push(e.replace("- ","").trim());else if(yamlDynamicContent&&e.match(c))E=e.match(c)[1]?e.match(c)[1]:"",r.push(e+"\n"),u=!0;else if(yamlDynamicContent&&e.match("`endif`"))E="",r.push(e+"\n"),u=!0;else if(e.match(i)){u=!1,o||(o=[]),m=l.test(e);const t=e.replace(/^\d+(\.|\))\s/,"").trim();let n=t.replace(/^\[.*?\]\(/,"").replace(/\)$/,"");n=yamlObfuscate?btoa(n):n;const s=t.replace(/\]\(.*/,"").replace(/^\[/,"");o.push([s,n,m,E])}else e.length>0&&!e.startsWith("# ")&&(r.push(e),u=!0);n.push([s,a,r,o]);const k=[d,p];return n.push(k),n.push(w),n}getMarkdownContent();