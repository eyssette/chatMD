let md="---\ngestionGrosMots: true\n---\n# ChatMD\n\nBonjour, je suis **ChatMD**, un outil libre et gratuit qui permet de créer facilement un chatbot personnalisé à partir d'un simple fichier en Markdown.\n\n:::info C'est très simple !\n1. Créez un fichier en Markdown accessible en ligne.\n2. Respectez la syntaxe de ChatMD pour définir votre chatbot.\n3. Votre chatbot est alors accessible à l'adresse suivante : [https://chatmd.forge.apps.education.fr/#URL](https://chatmd.forge.apps.education.fr/#URL) <br>(Mettez l'url de votre fichier à la place de URL) !\n:::\n\nOn peut imaginer **de nombreux usages** :\n- Tutoriel pour un outil informatique\n- Guide méthodologique\n- Soutien pour la révision d'un cours, quiz interactif,\n- Discussion avec un personnage historique,\n- Histoire dont vous êtes le héros …\n\nLa syntaxe de base est simple, mais ChatMD peut être configuré pour des **usages plus complexes** : personnalisation de l'interface, utilisation de variables, de choix aléatoires, intégration avec un LLM, possibilité de faire du RAG …\n\n1. [Qu'est-ce que le Markdown ?](Markdown)\n2. [Comment créer un fichier en Markdown accessible en ligne ?](Comment créer un fichier en Markdown accessible en ligne ?)\n3. [Quelle syntaxe faut-il respecter pour ChatMD ?](Syntaxe)\n4. [Donne-moi des exemples !](Exemples)\n5. [Quelles sont les options de configuration plus avancées ?](Options de configuration)\n6. [Comment intégrer mon chatbot dans un site ?](Comment intégrer mon chatbot sur un site ?)\n\n## Markdown\n- markdown\n\nLe Markdown est un format de balisage très léger qui permet d'écrire rapidement du texte formaté.\n\nPar exemple on écrit `**texte en gras**` pour écrire du **texte en gras**, ou alors `_texte en italique_` pour écrire du _texte en italique_.\n\nPour découvrir le Markdown, vous pouvez suivre ce [tutoriel](https://www.markdowntutorial.com/fr/).\n\n1. [OK, j'ai compris ce qu'est le Markdown, mais comment créer un fichier en Markdown accessible en ligne ?](Comment créer un fichier en Markdown accessible en ligne ?)\n2. [J'ai compris la syntaxe du Markdown, mais quelle est la syntaxe à respecter pour ChatMD ?](Syntaxe)\n\n## Comment créer un fichier en Markdown accessible en ligne ?\n- codimd\n- codi\n- forge\n- en ligne\n- digipage\n- hedgedoc\n- framapd\n\nIl existe plusieurs services pour créer un fichier Markdown accessible en ligne.\n\nSi vous êtes prof en France et que avez des identifiants académiques, vous pouvez utiliser [CodiMD](https://codimd.apps.education.fr/) sur le [portail Apps Edu](https://portail.apps.education.fr/).\n\nD'autres outils fonctionnent avec ChatMD et notamment : [Digipage](https://digipage.app/) de La Digitale et [Framapad](https://framapad.org/) de Framasoft\n\nIl est également possible d'utiliser la [Forge des Communs Numériques Éducatifs](https://forge.apps.education.fr/).\n\n1. [Qu'est-ce qu'une forge ?](forge)\n2. [J'ai compris comment créer mon fichier, mais quelle est la syntaxe à respecter pour ChatMD ?](Syntaxe)\n\n## forge\n- forge\n\nUne forge est un outil qui permet d'héberger des fichiers texte et de les transformer en site web, en carte mentale, ou encore ici en chatbot ! ChatMD est présent sur la [Forge des Communs Numériques Éducatifs](https://forge.apps.education.fr/) et vous pouvez aussi mettre vos fichiers sur cette forge.\n\nSi vous êtes prof en France et que vous souhaitez utiliser la forge, rejoignez le [groupe Tchap de LaForgeÉdu](https://www.tchap.gouv.fr/#/room/!fnVhKrpqraWfsSirBK:agent.education.tchap.gouv.fr) pour plus d'explications !\n\n1. [J'ai compris comment créer mon fichier, mais quelle est la syntaxe à respecter pour ChatMD ?](Syntaxe)\n\n## Syntaxe\n- syntaxe\n- règles\n- comment\n\nLa syntaxe pour écrire un chatbot avec chatMD est la suivante, mais c'est peut-être plus simple de [voir des exemples](#Exemples) ou bien de [récupérer un modèle](https://codimd.apps.education.fr/mBGbHStJSVOSrlGfGb981A?both).\n\n```\n​# Titre du chatbot\n​Message initial\n​1​. [Premier choix](Réponse 1)\n2​. [Deuxième choix](Réponse 2)\n​\n​## Réponse 1\n- déclencheur 1 (optionnel)\n- déclencheur 2 (optionnel)\nContenu de la réponse\n​1​. [Proposition 1](Titre Proposition 1)\n2​. [Proposition 2](Titre Proposition 2)\n```\n\nDans le message initial et le contenu de chaque réponse, **on peut utiliser toute la syntaxe Markdown** : intégrer des images, des vidéos, des iframes, et même utiliser des balises HTML.\n\nLes **titres de niveau 2** servent à identifier les réponses possibles du chatbot\n\n### Deux manières pour déclencher une réponse\n\n:::info Avec la souris, l'utilisateur clique sur une proposition\nPour créer des boutons qui déclenchent des réponses quand on clique dessus, il faut utiliser une liste ordonnée en Markdown, qui doit avoir la forme suivante : \n` 1. [intitulé de l'option qui s'affiche pour l'utilisateur](titre de la réponse correspondante dans le fichier en Markdown)`\n:::\n\n:::info Avec le clavier, l'utilisateur pose une question\nPour permettre au chatbot de renvoyer la réponse la plus adéquate, on indique sous le titre de la réponse des déclencheurs (mots clés ou expressions) qui vont renforcer le choix de cette réponse. On utilise une liste non ordonnée en Markdown.\n:::\n\nIl est préférable de combiner ces 2 options pour être sûr que l'utilisateur trouve les réponses à ses questions !\n\n1. [J'ai compris la syntaxe de base, mais quelles sont les options de configuration plus avancées](Options de configuration)\n2. [Si on utilise des déclencheurs, comment fonctionne le choix de la réponse la plus adéquate ?](explication choix réponse adéquate)\n\n## explication choix réponse adéquate\n\nSi on utilise des déclencheurs, ChatMD calcule la réponse la plus adéquate.\n\nCe n'est pas une simple recherche d'occurrences : le calcul intègre une décomposition en tokens et un calcul de distance lexicale.\n\nLa décomposition en tokens permet de retrouver des racines communes et la distance lexicale permet de trouver une réponse malgré des fautes d'orthographe.\n\n## Options de configuration\n- options\n- configuration\n- avancé\n- personnalisation\n- personnaliser\n\nPlusieurs options de configuration sont disponibles !\nLa plupart des options reposent sur l'ajout de paramètres dans l'en-tête YAML du fichier Markdown.\n\nQue voulez-vous faire ?\n\n1. [Améliorer l'algorithme de choix d'une réponse](option : Améliorer l'algorithme)\n2. [Personnaliser l'apparence du chatbot](option : Personnaliser l'apparence)\n3. [Gérer des contenus particuliers : admonitions, mathématiques, schémas, sons …](option : Gérer des contenus particuliers)\n4. [Organiser mon fichier source](option : Organiser son fichier source)\n5. [Utiliser ChatMD pour faire des quiz](option : Utiliser ChatMD pour faire des quiz)\n6. [Introduire de l'aléatoire dans les réponses ou les propositions en fin de message](option : Introduire de l'aléatoire)\n7. [Utiliser des variables dynamiques et du conditionnement en fonction de ces variables](option : Variables dynamiques)\n8. [Connecter ChatMD à un LLM, faire du RAG](option : Connecter ChatMD à un LLM, faire du RAG)\n9. [Avoir plusieurs bots différents](option: Avoir plusieurs bots différents)\n10. [Qu'est-ce qu'un en-tête YAML ?](Explication en-tête yaml)\n\n## Explication en-tête yaml\n\nUn en-tête YAML est une section spéciale dans laquelle on déclare certaines variables, qu'un programme comme ChatMD peut ensuite utiliser.\nCet en-tête doit se trouver au tout début du fichier. Il faut commencer et terminer l'en-tête par trois tirets `-​-​-`.\n\nVoici un exemple d'en-tête YAML :\n\n```\n-​-​-\ngestionGrosMots: true\n-​-​-\n```\n\n## option : Améliorer l'algorithme\n- algorithme\n- gros mot\n- insulte\n- message par défaut\n\nPour améliorer l'algorithme de choix d'une réponse, vous pouvez utiliser ces paramètres dans l'en-tête YAML : \n\n- si on ajoute `rechercheContenu: true`, alors l'algorithme ne se contente pas de comparer le message de l'utilisateur avec le titre de la réponse et les déclencheurs, mais il compare aussi ce message avec le contenu entier de la réponse. Attention, dans ce cas, le chatbot peut mettre un peu plus de temps à se charger.\n- `gestionGrosMots: true` permet de détecter les gros mots et les insultes envoyés par l'utilisateur et de formuler une réponse adéquate si l'utilisateur en utilise.\n- `messageParDéfaut: [\"message 1\", \"message 2\", \"message 3\"]` permet de modifier le message par défaut qui s'affiche aléatoirement quand le chatbot n'a pas trouvé de réponse pertinente.\n\n1. [Qu'est-ce qu'un en-tête YAML ?](Explication en-tête yaml)\n2. [Je veux voir les autres options de configurations](Options de configuration)\n\n## option : Personnaliser l'apparence\n- personnaliser l'apparence\n- modifier l'apparence\n- changer l'apparence\n- avatar\n- effet\n- clavier\n- style\n- css\n- thème\n- favicon\n\nPour personnaliser l'apparence du chatbot, vous pouvez utiliser ces paramètres dans l'en-tête YAML :\n\n- `style: a{color:red}` permet d'ajouter des styles CSS personnalisés.\n- `avatar: URL` permet de changer l'avatar du chatbot (il faut mettre l'url de son image à la place de URL)\n- `favicon: URL` permet de changer l'icône du chatbot dans les onglets (il faut mettre l'url de son image à la place de URL)\n- `footer: false` permet de supprimer le pied de page\n- `footer: 'Mon footer'` permet de customiser ce qui apparaît dans le pied de page\n- `theme: bubbles` permet d'utiliser un thème CSS particulier (ici le thème \"bubbles\")\n- `typewriter: false` désactive l'effet “machine à écrire”\n- `clavier: false` désactive le champ d'entrée clavier si on souhaite simplement guider l'utilisateur avec les options proposées en fin de chaque réponse.\n\nSi on veut activer ou désactiver le clavier pour certaines réponses, on met `&#96@​KEYBOARD = true&#96` ou `&#96@​KEYBOARD = false&#96` à l'intérieur de son code markdown pour les réponses en question..\n\nSi on veut désactiver l'effet typewriter pour un passage seulement de son texte, on utilise la syntaxe suivante dans son code markdown : `\\&#96texte sans effet typewriter\\&#96`\n\n1. [Qu'est-ce qu'un en-tête YAML ?](Explication en-tête yaml)\n2. [Je veux voir les autres options de configurations](Options de configuration)\n\n## option : Gérer des contenus particuliers\n- admonition\n- iframe\n- audio\n- son\n- latex\n- mathématiques\n- schémas\n- h5p\n\n### Admonitions\n\nDans le contenu en Markdown, vous pouvez utiliser des admonitions, c'est-à-dire des encadrés pour mettre en valeur certains contenus. Il faut utiliser la syntaxe suivante : \n```\n:​:​:info\ncontenu\n:​:​:\n```\n\nPlusieurs types d'admonitions sont disponibles (voir cet [exemple](https://codimd.apps.education.fr/9U7L4wpOSmaRFl6aRK-J9Q?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/9U7L4wpOSmaRFl6aRK-J9Q))\n\n### iframes et audio\n\nVous pouvez aussi utiliser :\n1. des iframes pour intégrer des contenus interactifs comme H5P. Attention, il vaut mieux que le contenu en iframe soit le dernier contenu de votre réponse, car sinon votre iframe risque de mettre du temps à s'afficher.\n2. la directive `!​Audio : URLduFichierAudio` pour jouer automatiquement un son lors du déclenchement d'une réponse (voir cet [exemple](https://codimd.apps.education.fr/24OabQgvQ_yPd2WE3DrIEg?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/24OabQgvQ_yPd2WE3DrIEg)).\n\n### Latex\n\nPour utiliser le Latex pour les mathématiques, il faut ajouter `maths: true` dans le YAML. On peut alors écrire des formules mathématiques en Latex avec la syntaxe `$Latex$` (à l'intérieur d'un paragraphe) ou `$$Latex$$` (pour un paragraphe à part).\n\t\n### Schémas & graphiques\n\nPour pouvoir générer des schémas et graphiques via le service Kroki, il faut ajouter `addOns: kroki` dans le YAML. Cela permet de générer des schémas avec la syntaxe de Tikz, GraphViz, Mermaid, PlantUML ou Excalidraw, et des graphiques avec Vega ou Vegalite (voir cet [exemple](https://codimd.apps.education.fr/dJpCzTg0SPyPmbj24SSKbg?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/dJpCzTg0SPyPmbj24SSKbg)).\n\n1. [Qu'est-ce qu'un en-tête YAML ?](Explication en-tête yaml)\n2. [Je veux voir les autres options de configurations](Options de configuration)\n\n## option : Organiser son fichier source\n- organiser\n- variables fixes\n- plusieurs fichiers\n\n### Variables fixes\n\nSi votre chatbot devient un peu long et complexe, vous pouvez définir des variables fixes dans le YAML.\n\n```\nvariables:\n\tmaVariable1: \"Ceci est ma variable 1\"\n\tmaVariable2: \"Ceci est ma variable 2\"\n```\n\nDans votre contenu en Markdown, vous pourrez alors utiliser vos variables ainsi : &#64;{maVariable1}\n\nLes variables fixes qui ne commencent pas par `_` sont interprétées au moment du déclenchement de la réponse, ce qui permet d'intégrer de l'aléatoire, en séparant les contenus possibles par `///`.\nLes variables fixes qui commencent par `_` sont interprétées au moment de la génération du chatbot, ce qui permet de créer des variables fixes qui intègrent des propositions en fin de message.\n\n&rArr; Voir cet [exemple](https://codimd.apps.education.fr/WySjMI5iQKOtTSJ3XhCZBQ?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/WySjMI5iQKOtTSJ3XhCZBQ)\n\n### Source répartie entre plusieurs fichiers\n\nSi votre chatbot est très long, vous pouvez répartir la source de votre fichier dans plusieurs fichiers. Pour cela, il faut dupliquer le projet sur la forge et utiliser la fonction “raccourci” afin d'indiquer comme source plusieurs fichiers.\n\n### Structuration du document\n\nSi vous souhaitez pouvoir structurer les propositions en fin de message avec des titres, il faut écrire les options avec le code HTML nécessaire directement et non pas avec la syntaxe Markdown (voir cet [exemple](https://codimd.apps.education.fr/NJs77ZWnQgalVyA6nfuDLQ?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/NJs77ZWnQgalVyA6nfuDLQ)).\n\nVous pouvez aussi ajouter dans le contenu Markdown des liens vers d'autres réponses, sans générer de bouton en fin de message, avec la syntaxe suivante : `[intitulé du lien]​(#titre de la réponse)`\n\n`titresRéponses: [\"### \", \"#### \"]` dans le YAML permet de changer les identifiants possibles des réponses du chatbot si on veut pouvoir structurer autrement les réponses du chatbot dans son document\n\n1. [Qu'est-ce qu'un en-tête YAML ?](Explication en-tête yaml)\n2. [Je veux voir les autres options de configurations](Options de configuration)\n\n\n## option : Utiliser ChatMD pour faire des quiz\n- quiz\n\nUn chatbot sert souvent à répondre à des questions, mais on peut aussi utiliser ChatMD pour poser des questions !\n\nSi on veut que l'utilisateur réponde avec le clavier, la directive `!​Next: Titreréponse`, dans le contenu du Markdown, va forcer la redirection vers une réponse particulière : le message de l'utilisateur sera alors comparé aux déclencheurs choisis pour cette réponse ou même au contenu entier de la réponse si on a ajouté `rechercheContenu: true` dans le YAML. Si le message correspond, alors la réponse de l'utilisateur est considérée comme juste (voir cet [exemple](https://codimd.apps.education.fr/sp8dwq5rQGq3pIj2DPBD0A?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/sp8dwq5rQGq3pIj2DPBD0A)).\n\nSi on veut que l'utilisateur réponde en cliquant sur des propositions, on peut utiliser la propriété `obfuscate: true` dans l'en-tête YAML pour cacher le titre des liens, afin d'éviter de donner un indice en survolant un lien (voir cet [exemple](https://codimd.apps.education.fr/hWgravuHTTmfRydTUfjgWQ?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/hWgravuHTTmfRydTUfjgWQ)).\n\nOn peut aussi introduire de l'aléatoire dans le choix des propositions (voir ci-dessous).\n\n1. [Qu'est-ce qu'un en-tête YAML ?](Explication en-tête yaml)\n2. [Comment introduire de l'aléatoire ?](option : Introduire de l'aléatoire)\n3. [Je veux voir les autres options de configurations](Options de configuration)\n\n\n## option : Introduire de l'aléatoire\n- aléatoire\n\nDans le contenu du Markdown, on peut indiquer plusieurs versions d'une même réponse en les séparant avec le séparateur `-​-​-`. Le chatbot sélectionnera aléatoirement l'une de ces versions.\n\nOn peut également choisir d'afficher seulement les propositions en fin de message de manière aléatoire. Si on met `1. [intitulé]​(lien)` : la proposition reste à la place indiquée, alors que si on met `1) [intitulé]​(lien)` : la proposition est réordonnée de manière aléatoire.\n\nDans le contenu du Markdown, la directive : `!​Select: x` peut être ajoutée juste avant la liste des propositions en fin de message, afin de sélectionner aléatoirement x propositions parmi cette liste (voir cet [exemple](https://codimd.apps.education.fr/f6QP57QNT2S-crAjOwdahg?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/f6QP57QNT2S-crAjOwdahg)).\n\nEnfin, la directive `!​SelectNext: titre question 1 / titre question 2 / titre question 3` permet de renvoyer de manière aléatoire vers une question parmi un ensemble de questions qu'on a choisies (voir cet [exemple](https://codimd.apps.education.fr/Yvq5u2btTOmrTFCFoXGTwg?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/Yvq5u2btTOmrTFCFoXGTwg)).\n\n1. [Qu'est-ce qu'un en-tête YAML ?](Explication en-tête yaml)\n2. [Je veux voir les autres options de configurations](Options de configuration)\n\n\n## option : Variables dynamiques\n- variables dynamiques\n- conditionnement\n- conditionner\n- paramètres dans l'URL\n- paramètres URL\n\nPour utiliser les variables dynamiques, il faut ajouter `contenuDynamique: true` dans le YAML.\n\nOn peut avoir des variables dynamiques définies selon le parcours de l'utilisateur, et conditionner du contenu en fonction de ces variables.\n\nOn définit une variable soit dans le contenu en Markdown de la réponse, soit dans un bouton de réponse en fin de message. On utilise la syntaxe suivante : `@​mavariable=contenu de ma variable` que l'on place soit dans un bloc code dans le contenu de sa réponse : `&#96@​mavariable=contenu de ma variable&#96`, soit directement dans l'intitulé du lien du bouton de réponse : `1. [intitulé @​mavariable=contenu de ma variable](titre réponse)`.\n\nPour le conditionnement, on commence un bloc code avec `i​f` puis l'ensemble des conditions (par exemple `&#96i​f @​mavariable1 == valeur1 && @​mavariable == valeur2&#96`), puis on met ensuite ce qui doit s'afficher si cette condition est vérifiée, et on termine par un bloc code :  `&#96end​if&#96`.\n\n&rArr; Voir cet [exemple](https://codimd.apps.education.fr/1l7Md8q-SjG0yLGHfH4wbg?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/1l7Md8q-SjG0yLGHfH4wbg)\n\nOn peut également récupérer des paramètres dans l'URL pour les utiliser ensuite. Chaque paramètre est récupéré dans une variable : `@​GE​Tnomduparamètre` que l'on peut utiliser comme les autres variables dynamiques.\n\nOn peut récupérer le contenu d'un message entré par un utilisateur pour l'assigner à une variable dynamique en utilisant la syntaxe : `@​mavariable  = @​INPUT : Titre réponse`. Le message de l'utilisateur sera assigné à la variable et l'utilisateur sera redirigé automatiquement vers la réponse dont on a indiqué le titre.\n\n&rArr; Voir cet [exemple](https://codimd.apps.education.fr/_2I1TWwBT22IML7BsR7sWw?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/_2I1TWwBT22IML7BsR7sWw)\n\nOn peut enfin utiliser des opérations élémentaires pour calculer la valeur d'une variable (afin de calculer un score par exemple). Par exemple, on pourrait écrire : `@​mavariable  = c​alc(@​score+1)` soit dans un bloc code, soit dans un bouton en fin de message. À la place de `c​alc(@​score+1)`, on peut mettre une expression plus complexes avec plusieurs variables dynamiques. Les opérations autorisées sont l'addition, la soustraction, la multiplication, la division, la concaténation (avec le même signe que pour l'addition).\n\n&rArr; Voir cet [exemple](https://codimd.apps.education.fr/6ZFeM407RbyCPxpAxKU8ow?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/6ZFeM407RbyCPxpAxKU8ow)\n\n1. [Qu'est-ce qu'un en-tête YAML ?](Explication en-tête yaml)\n2. [Je veux voir les autres options de configurations](Options de configuration)\n\n\n## option : Connecter ChatMD à un LLM, faire du RAG\n- LLM\n- RAG\n\nChatMD peut se connecter à un LLM en ligne ou en local : on peut choisir le modèle que l'on souhaite et tout configurer (préprompt, nombre de tokens, etc.). Pour faire appel à ce LLM, on peut soit décider de toujours produire la réponse par le LLM, en prenant en compte les éléments prédéfinis, soit n'utiliser le LLM qu'à des moments bien précis, par exemple pour enrichir une réponse préprogrammée.\n\nChatMD permet également de faire du RAG de manière simplifiée : on peut indiquer des sources d'informations, qui seront utilisées par le LLM pour produire sa réponse.\nCe RAG ne repose pas sur une vectorisation préalable de l'information. On pourrait le faire, mais l'intérêt est ici de ne pas multiplier les appels à une API externe, afin d'avoir un usage plus sobre de l'IA.\n\nPour comprendre comment tout cela fonctionne, le mieux est de regarder ces deux exemples :\n- [Utiliser ChatMD avec un LLM en local](https://codimd.apps.education.fr/unR-D6xRSMOnvySa5-kCdg?both)\n- [Utiliser ChatMD avec un LLM en ligne](https://codimd.apps.education.fr/nVOl6sQKTfqq_OWAUmxcYg?both)\n\n1. [Qu'est-ce qu'un en-tête YAML ?](Explication en-tête yaml)\n2. [Je veux voir les autres options de configurations](Options de configuration)\n\n## option: Avoir plusieurs bots différents\n- plusieurs bots\n- plusieurs chatbots\n- plusieurs avatars\n- différents bots\n- différents chatbots\n- différents avatars\n\nOn peut utiliser ChatMD pour gérer plusieurs bots différents.\n\nIl faut d'abord déclarer les bots dans le yaml ainsi :\n\n```\nbots:\n\tnomBot1:\n\t\tavatar: URLimageBot1\n\t\tcssAvatar: \"CSS particulier pour l'avatar du Bot1\"\n\t\tcssMessage: \"CSS particulier pour les messages du Bot1\"\n\tnomBot2:\n\t\tavatar: URLimageBot2\n\t\tcssAvatar: \"CSS particulier pour l'avatar du Bot2\"\n\t\tcssMessage: \"CSS particulier pour les messages du Bot2\"\n```\n\nPour utiliser un bot, on utilise la directive `!​Bot: botName` pour indiquer que la réponse doit être faite par le bot qui a pour nom `botName`.\n\n&rArr; Voir cet [exemple](https://codimd.apps.education.fr/pKXavCOeTfityYVTTS6aMA?both) et le [chatbot correspondant](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/pKXavCOeTfityYVTTS6aMA)\n\n\n## Exemples\n- exemple\n- donner un exemple\n- concret\n- concrètement\n- modèle\n- template\n\nVoici un modèle que vous pouvez récupérer pour construire votre chatbot : [modèle à récupérer](https://codimd.apps.education.fr/mBGbHStJSVOSrlGfGb981A?both)\n\nVoici quelques exemples de chatbot créés avec ChatMD : \n\n- [Méthode de la dissertation en philosophie](https://chatmd.forge.apps.education.fr/#https://eyssette.forge.apps.education.fr/chatbot/dissertation-philosophie.md)\n- [Utilisation d'un microscope](https://chatmd.forge.apps.education.fr/#https://codimd.apps.education.fr/xGNHIJSeTVCk6FHas-_71g) : un chatbot créé à partir du travail de  Sylvain Tissier, Guillaume Berthelot et de Jérémy Navoizat [voir la source](https://codimd.apps.education.fr/xGNHIJSeTVCk6FHas-_71g?both)\n\nN'hésitez pas à partager vos exemples de chatbot avec moi ! Vous pouvez me contacter sur [Mastodon](https://scholar.social/@eyssette).\n\n## Comment intégrer mon chatbot sur un site ?\n- widget\n- dans son site\n- dans mon site\n- intégrer\n- intégration\n- sur mon site\n- sur son site\n- iframe\n\nVous pouvez intégrer chatMD dans votre site de deux manières : soit avec une balise iframe, soit en tant que widget.\n\n### Iframe\nPour utiliser ChatMD avec une balise iframe, vous pouvez utiliser le code suivant (en modifiant le style CSS si nécessaire) :\n\n```html\n<iframe src=https://chatmd.forge.apps.education.fr/#URLDEVOTRECHATBOT\" style=\"border:0; width:100%; height:700px\"></iframe>\n```\n\n### Widget\nPour utiliser ChatMD en tant que widget, il faut avoir accès au HTML et insérer ce code (en bas de page dans l'élément `body`).\n\n```js\n<script id=\"chatmdWidgetScript\"\nsrc=\"https://chatmd.forge.apps.education.fr/widget.min.js\" \ndata-chatbot=\"URL_SOURCE_CHATBOT\"><\/script>\n```\n\nIl faut bien sûr remplacer `URL_SOURCE_CHATBOT` par l'URL de la source de votre chatbot.\n\nOn peut customiser l'image du widget en ajoutant `data-image=\"URL_IMAGE\"` comme paramètre.\n\n## Merci\n- merci\n- remercier\n- remercie\n- félicitations\n- félicit\n- bravo\n- super\n- excellent\n- génial\n- wow\n- chouette\n- sympa\n- cool\n\nMerci ! Si vous aimez ce travail, vous aimerez peut-être aussi les autres outils ou sites que je propose sur [mon site perso](https://eyssette.forge.apps.education.fr).\n\n",defaultMessage=["Désolé, je ne comprends pas votre question.","Pardonnez-moi, mais je ne saisis pas votre demande.","Excusez-moi, je ne parviens pas à comprendre ce que vous demandez.","Je suis navré, mais je ne parviens pas à saisir votre question.","Malheureusement, je ne suis pas en mesure de comprendre votre question.","Je suis désolé, mais je ne saisis pas votre question.","Pardonnez-moi, mais je ne saisis pas le sens de votre question.","Je m'excuse, mais je ne parviens pas à saisir votre demande. Pouvez-vous reformuler votre question, s'il vous plaît ?","Je ne suis pas sûr de comprendre ce que vous demandez. Pouvez-vous expliquer davantage ?","Je ne peux pas répondre à votre question telle qu'elle est formulée. Pouvez-vous la poser différemment ?","Votre question ne semble pas correspondre à mes capacités actuelles. Pourriez-vous la reformuler autrement ?","Je n'ai malheureusement pas compris votre requête.","Je suis désolé, je ne suis pas capable de répondre.","Malheureusement, je ne peux pas répondre à votre question.","Malheureusement je n'arrive pas à comprendre votre requête.","Excusez-moi, je ne comprends pas votre requête.","Excusez-moi, je n'arrive pas à répondre à votre question.","Je ne parviens pas à répondre à votre requête. Veuillez m'excuser."];const badWordsMessage=["Même si je ne suis qu'un chatbot, merci de vous adresser à moi avec un langage approprié","Je préférerais que nous restions courtois dans notre communication.","Les insultes ne sont pas nécessaires. Comment puis-je vous aider autrement ?","Essayons de garder une conversation respectueuse.","Je préfère une conversation respectueuse et productive.","Je vous encourage à reformuler votre question ou commentaire de manière respectueuse.","Les mots offensants ne sont pas nécessaires ici. Comment puis-je vous aider de manière constructive ?","Restons courtois dans nos échanges, s'il vous plaît.","Injures et grossièretés ne mènent nulle part. Comment puis-je vous assister ?","Je suis ouvert à la discussion, mais veuillez garder un langage respectueux.","Essayons de communiquer de manière civilisée !"],shortcuts=[["dissertation-philo","https://raw.githubusercontent.com/eyssette/chatbot/main/dissertation-philosophie.md"],["multiple-urls",["https://codimd.apps.education.fr/t7yi1Ak7Q--r2r4oB-3Uhg/download","https://codimd.apps.education.fr/fqjqvdIkQvWD-PVGONrq2g/download"]]],corsProxy="https://corsproxy.io/?";let responsesTitles=["## "];const allowedAddOns={pako:{js:"externals/pako.min.js"},kroki:{js:"externals/kroki.js"},textFit:{js:"externals/textFit.min.js",css:"<style>.katex-display{max-width:80%} .katex-display .textFitted{white-space:nowrap}</style>"}},addOnsDependencies={kroki:["pako"]};let yamlUseAddOns,yamlData,yamlBots,yamlUseLLM,yamlUseLLMurl,yamlUseLLMmodel,yamlStyle="",yamlUserInput=!0,yamlSearchInContent=!1,yamldetectBadWords=!1,yamlMaths=!1,yamlFooter=!0,yamlTheme="",yamlDynamicContent=!1,yamlTypeWriter=!0,yamlObfuscate=!1,yamlUseLLMapiKey="",yamlUseLLMalways=!1;const defaultMaxTokens=100,defaultSystemPrompt="Tu es un assistant efficace qui réponds en français et pas dans une autre langue. Les phrases de réponse doivent être courtes et claires.",defaultPostprompt="\nN'oublie pas de répondre en français.";let yamlUseLLMsystemPrompt=defaultSystemPrompt,yamlUseLLMmaxTokens=defaultMaxTokens,yamlUseLLMinformations="",yamlUseLLMpreprompt="",yamlUseLLMpostprompt=defaultPostprompt;const defaultRAGprompt="\nVoici ci-dessous le contexte à partir duquel tu dois partir pour construire ta réponse, tu dois sélectionner dans ce contexte l'information pertinente et ne pas parler du reste. Si l'information n'est pas dans le contexte, indique-le et essaie de répondre malgré tout.\nCONTEXTE : ",defaultRAGpromptStrict="\nVoici ci-dessous le contexte à partir duquel tu dois construire ta réponse, tu dois sélectionner dans ce contexte l'information pertinente et ne pas parler du reste. Si la réponse à la question n'est pas dans le contexte, tu ne dois pas répondre et dire : je ne sais pas. \nCONTEXTE : ";let yamlUseLLMragSeparator="\n",yamlUseLLMmaxTopElements=3,yamlUseLLMragPrompt=defaultRAGprompt;function getRandomElement(e){return e[Math.floor(Math.random()*e.length)]}function startsWithAnyOf(e,t){for(const n of t)if(e.startsWith(n))return n}function topElements(e,t){let n;return(n=e.length<t?e.map((e,t)=>[e,t]):e.reduce((e,n,s)=>(e.length<t?(e.push([n,s]),e.sort((e,t)=>e[0]-t[0])):n>e[0][0]&&(e[0]=[n,s],e.sort((e,t)=>e[0]-t[0])),e),[])).sort((e,t)=>t[0]-e[0]),n}function shuffleArray(e){return e.sort(function(){return Math.random()-.5})}function randomizeArrayWithFixedElements(e){let t=[],n=[];e.forEach(function(e){e[2]?n.push(e):t.push(e)}),n=shuffleArray(n);var s=[];return e.forEach(function(e){e[2]?s.push(n.shift()):s.push(e)}),s}function shouldBeRandomized(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)if(!0===e[t][2])return!0;return!1}function handleURL(e){if(""!==e){let t=!0;const n=shortcuts.find(t=>t[0]==e);if(n)return e=n[1];e.includes(".forge")&&(t=!1),e.startsWith("https://github.com")&&(t=!1,e=(e=e.replace("https://github.com","https://raw.githubusercontent.com")).replace("/blob/","/")),(e.startsWith("https://codimd")||e.includes("hedgedoc")||e.includes("digipage"))&&(t=!1,e=-1===(e=e.replace("?edit","").replace("?both","").replace("?view","").replace(/#$/,"").replace(/\/$/,"")).indexOf("download")?e+"/download":e),!e.includes("framapad")&&!e.includes("digidoc")||e.endsWith("/export/txt")||(t=!1,e=e.replace(/\?.*/,"")+"/export/txt"),e=t?corsProxy+e:e}return e}function loadScript(e){return new Promise((t,n)=>{const s=document.createElement("script");s.src=e,s.onload=t,s.onerror=n,document.head.appendChild(s)})}function loadCSS(e){return new Promise((t,n)=>{let s;e.startsWith("<style>")?(s=document.createElement("style")).textContent=e.replace("<style>","").replace("</style>",""):((s=document.createElement("link")).href=e,s.rel="stylesheet",s.onload=t,s.onerror=n),document.head.appendChild(s)})}function scrollWindow(){setTimeout(()=>{window.scrollTo(0,document.body.scrollHeight)},100)}const footerElement=document.getElementById("footer");function hideFooter(){const e=document.getElementById("controls");footerElement.style.display="none",e.style.height="70px";const t=document.createElement("style");t.innerText="@media screen and (max-width: 500px) { #controls {height:110px!important}}",document.head.appendChild(t)}function tryConvertStringToNumber(e){const t=parseFloat(e);return isNaN(t)||t.toString()!==e.toString().trim()?e:t}function processFixedVariables(e,t=!1){const n=t?/@{(_\S+)}/g:/@{(\S+)}/g;return e.replaceAll(n,function(n,s,r){const a=e.lastIndexOf(n);if(yamlData&&yamlData.variables&&yamlData.variables[s]){const e=getRandomElement(yamlData.variables[s].split("///"));return t&&r==a&&delete yamlData.variables[s],e}return"@{"+s+"}"})}function showdownExtensionAdmonitions(){return[{type:"output",filter:e=>{const t=(e=e.replaceAll(/<p>:::(.*?)<\/p>/g,":::$1")).match(/:::(.*?)\n(.*?):::/gs);if(t){let n=e;for(const s of t){const t=/:::(.*?)\s(.*?)\n(.*?):::/s.exec(s),r=e.indexOf(s);if(!("<code>"==e.substring(r-6,r))){let e=t[1],r=t[2];e.includes("<br")&&(e=e.replace("<br",""),r="");const a=t[3];r.includes("collapsible")?(r=r.replace("collapsible",""),matchReplaced=`<div><div class="admonition ${e}"><details><summary class="admonitionTitle">${r}</summary><div class="admonitionContent">${a}</div></details></div></div>`):matchReplaced=`<div><div class="admonition ${e}"><div class="admonitionTitle">${r}</div><div class="admonitionContent">${a}</div></div></div>`,n=n.replaceAll(s,matchReplaced)}}return n}return e}}]}const converter=new showdown.Converter({emoji:!0,parseImgDimensions:!0,simpleLineBreaks:!0,simplifiedAutoLink:!0,tables:!0,openLinksInNewWindow:!0,extensions:[showdownExtensionAdmonitions]});function markdownToHTML(e){return e=e.replaceAll("\n\n|","|"),converter.makeHtml(e).replaceAll("&amp;#96","`&#96`")}function convertLatexExpressions(e){let t=(e=e.replace(/\$\$(.*?)\$\$/g,"&#92;[$1&#92;]").replace(/\$(.*?)\$/g,"&#92;($1&#92;)")).match(new RegExp(/&#92;\[.*?&#92;\]|&#92;\(.*?&#92;\)/g));if(t)for(let n of t){const t=!!n.includes("&#92;[");let s=n.replace("&#92;[","").replace("&#92;]","");s=(s=(s=s.replace("&#92;(","").replace("&#92;)","")).replaceAll("&lt;","\\lt").replaceAll("&gt;","\\gt")).replaceAll("<em>","_").replaceAll("</em>","_").replaceAll("&amp;","&").replaceAll(" ","\\ "),stringWithLatex=katex.renderToString(s,{displayMode:t}),e=e.replace(n,stringWithLatex)}return!0===yamlTypeWriter&&(e=(e=e.replaceAll(/(<span class="katex-mathml">(.|\n)*?<\/span>)/gm,"`$1`")).replaceAll(/(<span class=".?strut">.*?<\/span>)/g,"`$1`")),e}function levenshteinDistance(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;const n=[];for(let e=0;e<=t.length;e++)n[e]=[e];for(let t=0;t<=e.length;t++)n[0][t]=t;for(let s=1;s<=t.length;s++)for(let r=1;r<=e.length;r++){const a=e[r-1]===t[s-1]?0:1;n[s][r]=Math.min(n[s-1][r]+1,n[s][r-1]+1,n[s-1][r-1]+a)}return n[t.length][e.length]}function hasLevenshteinDistanceLessThan(e,t,n){const s=e.split(" ");for(const e of s){if(levenshteinDistance(e,t)<n)return!0}return!1}function removeAccents(e){const t={"à":"a","â":"a","é":"e","è":"e","ê":"e","ë":"e","î":"i","ï":"i","ô":"o","ö":"o","û":"u","ü":"u","ÿ":"y","ç":"c","À":"A","Â":"A","É":"E","È":"E","Ê":"E","Ë":"E","Î":"I","Ï":"I","Ô":"O","Ö":"O","Û":"U","Ü":"U","Ÿ":"Y","Ç":"C"};return e.replace(/[àâéèêëîïôöûüÿçÀÂÉÈÊËÎÏÔÖÛÜŸÇ]/g,e=>t[e]||e)}function dotProduct(e,t){const n=new Set([...Object.keys(e),...Object.keys(t)]);let s=0;for(const r of n)s+=(e[r]||0)*(t[r]||0);return s}function magnitude(e){let t=0;for(const n in e)t+=e[n]**2;return Math.sqrt(t)}let chatData,nextMessage="";function tokenize(e,t){let n=e.toLowerCase();n=(n=removeAccents(n=(n=n.replace(/,|\.|\:|\?|\!|\(|\)|\[|\||\/\]/g,"")).replaceAll("/"," "))).split(/\s|'/).map(e=>e.trim()).filter(e=>e.length>=5)||[];const s=[],r=[0,0,0,0,.4,.6,.8],a=.2,o=nextMessage?100:10;function i(e,n,s){let i=r[n-1];i=0===e?i+a:i;const l=s.substring(e,e+n);if(t){chatData[t][0].toLowerCase().includes(l)&&(i+=o)}return{token:l,weight:i}}for(let e=0;e<n.length;e++){const t=n[e];s.push({token:t,weight:5});const r=t.length;if(r>=5)for(let e=0;e<=r-5;e++)s.push(i(e,5,t));if(r>=6)for(let e=0;e<=r-6;e++)s.push(i(e,6,t));if(r>=7)for(let e=0;e<=r-7;e++)s.push(i(e,7,t))}return s}function createVector(e,t){const n=tokenize(e,t),s={};for(const{token:e,weight:t}of n)e&&(s[e]=(s[e]||0)+t);return s}function cosineSimilarity(e,t){const n=createVector(e),s=dotProduct(n,t),r=magnitude(n),a=magnitude(t);return 0===r||0===a?0:s/(r*a)}const chatContainer=document.getElementById("chat"),userInput=document.getElementById("user-input"),sendButton=document.getElementById("send-button"),isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),autoFocus=!isMobile,thresholdMouseMovement=5,regexPre=/(<pre(.|\n)*<\/pre>)/gm,regexMessageOptions=/(<ul class="messageOptions"\>[\s\S]*<\/ul>)/gm,regexIframe=/(<iframe(.|\n)*<\/iframe>)/gm,observerConfig={childList:!0,subtree:!0},messageTypeEnterToStopTypeWriter=isMobile?"Clic sur “Envoyer” pour stopper l'effet “machine à écrire”":window.innerWidth>880?"Appuyez sur “Enter” pour stopper l'effet “machine à écrire” et afficher la réponse immédiatement":"“Enter” pour stopper l'effet “machine à écrire”";let typed;const pauseTypeWriter="^300 ",stopTypeWriterExecutionTimeThreshold=800;function typeWriter(e,t){function n(e){typed.stop(),typed.reset();const t=(e=(e=e.replaceAll("`","")).replace(regexMessageOptions,"`$1`")).replaceAll(regexPre,function(e){return e.replaceAll("\n","RETURNCHARACTER")}).split("\n").map(e=>e.startsWith(pauseTypeWriter)?e.replace(pauseTypeWriter,"").replaceAll("RETURNCHARACTER","\n")+"`":e.endsWith("`")?"`"+e.replaceAll("RETURNCHARACTER","\n"):"`"+e.replaceAll("RETURNCHARACTER","\n")+"`");typed.strings=[t.join(" ")],typed.start(),typed.destroy()}function s(t){"Enter"===t.key&&(mutationObserver.disconnect(),o=!1,n(e))}let r=0;const a=Date.now();let o=!0;function i(){const t=Date.now()-a;50==r&&t>stopTypeWriterExecutionTimeThreshold&&o&&(n(e),o=!1,mutationObserver.disconnect()),scrollWindow(),r++}e=(e=e.replace(regexMessageOptions,pauseTypeWriter+"`$1`")).replaceAll(regexIframe,"`$1`"),typed=new Typed(t,{strings:[e],typeSpeed:-5e3,startDelay:100,showCursor:!1,onBegin:()=>{function e(){mutationObserver.observe(chatContainer,observerConfig)}autoFocus&&userInput.focus(),userInput.addEventListener("keypress",s),userInput.setAttribute("placeholder",messageTypeEnterToStopTypeWriter),mutationObserver=new MutationObserver(i),e(),setTimeout(()=>{document.addEventListener("mousemove",function(e){(Math.abs(e.movementX)>thresholdMouseMovement||Math.abs(e.movementY)>thresholdMouseMovement)&&(o=!1,mutationObserver.disconnect())}),document.addEventListener("wheel",function(t){t.deltaY>0&&window.scrollY+window.innerHeight>=document.body.offsetHeight?e():(o=!1,mutationObserver.disconnect())}),document.addEventListener("touchstart",function(){o=!1,mutationObserver.disconnect(),setTimeout(()=>{window.scrollY+window.innerHeight+200>=document.documentElement.scrollHeight&&e()},5e3)})},1e3)},onComplete:()=>{yamlUseAddOns&&yamlUseAddOns.includes("textFit")&&textFit(t.querySelectorAll(".katex-display")),userInput.removeEventListener("keypress",s),userInput.getAttribute("placeholder")==messageTypeEnterToStopTypeWriter&&userInput.setAttribute("placeholder","Écrivez votre message"),o=!1,mutationObserver.disconnect()}})}function displayMessage(e,t,n){chatContainer.appendChild(n),t||window.matchMedia("(prefers-reduced-motion: reduce)").matches||!1===yamlTypeWriter?n.innerHTML=e:typeWriter(e,n)}let nextMessageOnlyIfKeywords=!1,getLastMessage=!1;const sanitizeCodeAllowedOperations=["+","-","*","/","<=",">=","<",">","==","!=","&&","||","!"];function sanitizeCode(e){return codeWithoutAllowedOperations=e.replace(/tryConvertStringToNumber\(.*?\]\)/g,""),sanitizeCodeAllowedOperations.forEach(e=>{codeWithoutAllowedOperations=codeWithoutAllowedOperations.replaceAll(e,"///")}),codeWithoutAllowedOperations=codeWithoutAllowedOperations.replace(/[0-9]*/g,""),forbiddenExpressions=codeWithoutAllowedOperations.split("///"),forbiddenExpressions.forEach(t=>{e=e.replaceAll(t,"")}),e}function processComplexDynamicVariables(e,t){let n=e.replace(/@(\w+)/g,function(e,t){return'tryConvertStringToNumber(dynamicVariables["'+t.trim()+'"])'});return n=sanitizeCode(n),new Function("dynamicVariables","return "+n)(t)}function processDynamicVariables(e,t,n){if(n)e=e.replaceAll(/@([^\s]*?)\=(.*)/g,function(e,n,s,r){if(e.includes("calc("))try{const r=processComplexDynamicVariables(s.replace("calc(","").trim().slice(0,-1),t);t[n]=r}catch(t){return console.error("Error evaluating :",e,t),"\x3c!--"+e+"--\x3e"}else t[n]=s;return 0==r?s:""}),getLastMessage?getLastMessage&&getLastMessage.length>0?(t[getLastMessage[0]]=e,nextMessage=getLastMessage[1],getLastMessage=!1):nextMessage="":nextMessage=nextMessageOnlyIfKeywords?nextMessage:"";else{e=(e=e.replaceAll(/\`@([^\s]*?) ?= ?(?<!@)(.*?)\`/g,function(e,n,s){return e.includes("calc(")||e.includes("@INPUT")?e:(t[n]=s,e.includes("KEYBOARD")?"\x3c!--"+e+"--\x3e":"")})).replaceAll("\x3c!--\x3c!--","\x3c!--").replaceAll("--\x3e--\x3e","--\x3e"),!1===yamlUserInput?"true"==t.KEYBOARD?(document.body.classList.remove("hideControls"),t.KEYBOARD="false"):document.body.classList.add("hideControls"):"false"==t.KEYBOARD?(document.body.classList.add("hideControls"),t.KEYBOARD="true"):document.body.classList.remove("hideControls");const n=!!(e=e.replaceAll(/\`@([^\s]*?)\`/g,function(e,n){return e.includes("=")?e:t[n]?t[n]:e})).includes("calc(");e=e.replaceAll(/\`@([^\s]*?) ?= ?calc\((.*)\)\`/g,function(e,n,s){try{const r=processComplexDynamicVariables(s,t);return t[n]=r,""}catch(t){return console.error("Error evaluating :",e,t),"\x3c!--"+e+"--\x3e"}}),(n||e.includes("`@"))&&(e=e.replaceAll(/\`@([^\s]*?)\`/g,function(e,n){return e.includes("=")?e:t[n]?t[n]:""})),e=(e=(e=(e=(e=e.replaceAll(/\`@([^\s]*?) ?= ?@INPUT : (.*)\`/g,function(e,t,n){return getLastMessage=!!e&&[t,n],""})).replaceAll(/ (@[^\s]*?\=.*?)\</g,'<span class="hidden">$1</span><')).replaceAll(/>(@[^\s]*?\=)/g,'><span class="hidden">$1</span>')).replaceAll(/\`if (.*?)\`((\n|.*)*?)\`endif\`/g,function(e,n,s){if(!n)return"";try{if(n=(n=n.replace(/@([^\s()&|!=]+)/g,function(e,t){return'dynamicVariables["'+t.trim()+'"]'})).replaceAll(/(==|!=|<=|>=|<|>) ?(.*?) ?(\)|\&|\||$)/g,function(e,t,n,s){return`${t}"${n}" ${s}`}).replaceAll('""','"').replace('"undefined"',"undefined"),/^(\s*(!|\(|\)|&&|\|\||==|!=|===|!==|<=|>=|<|>|true|false|null|undefined|[0-9]+|[+-]?([0-9]*[.])?[0-9]+|"[^"]*"|'[^']*'|`[^`]*`|[a-zA-Z0-9_]+\[[^\]]+\]|\s+))*\s*$/.test(n)){return new Function("dynamicVariables","return "+n)(t)?s:""}throw new Error("Invalid expression")}catch(e){return console.error("Error evaluating condition:",n,e),"\x3c!--"+n+"--\x3e"}})).replaceAll(/\n\n\n*/g,"\n\n")}return e}let nextMessageOnlyIfKeywordsCount=0;const nextMessageOnlyIfKeywordsCountMax=3;let nextSelected,filterBadWords,messageIfKeywordsNotFound="",lastMessageFromBot="";function processDirectiveNext(e){return e=e.replaceAll(/!Next ?:(.*)/g,function(t,n){const s=n.split("/");let r;if(s.length>0?(n=s[0],r=s[1]):n=s[0],t&&nextMessageOnlyIfKeywordsCount<nextMessageOnlyIfKeywordsCountMax)return lastMessageFromBot=e,nextMessage=n.trim(),nextMessageOnlyIfKeywords=!0,messageIfKeywordsNotFound=r?r.trim():"Ce n'était pas la bonne réponse, merci de réessayer !",messageIfKeywordsNotFound+="\n\n",nextMessageOnlyIfKeywordsCount++,"\x3c!----\x3e";{lastMessageFromBot="";const e=nextMessage;if(nextMessage="",nextMessageOnlyIfKeywords=!1,nextMessageOnlyIfKeywordsCount==nextMessageOnlyIfKeywordsCountMax){return nextMessageOnlyIfKeywordsCount=0,`<ul class="messageOptions"><li><a href="#${yamlObfuscate?btoa(e):e}">Passer à la suite !</a></li></ul>`}}})}function processDirectiveSelectNext(e){return e=e.replaceAll(/!SelectNext:(.*)/g,function(e,t){if(e){const e=t.split("/");return lastMessageFromBot="",nextMessage="",nextMessageOnlyIfKeywords=!1,nextSelected=getRandomElement(e).trim(),""}nextSelected=void 0})}function processDirectiveSelect(e,t){return[e=e.replaceAll(/\!Select ?: ?([0-9]*)/g,function(e,n){return e&&n<=t.length?(t=shuffleArray(t).slice(0,n),"\x3c!--"+e+"--\x3e"):""}),t]}function processDirectiveBot(e,t){return e=e.replace(/!Bot:(.*)/,function(e,n){return e&&n&&(n=n.trim().replaceAll(" ",""),t.classList.add("botName-"+n)),""})}function processRandomMessage(e){const t=e.split("\n---\n");if(t.length>1){const n=e.indexOf('<ul class="messageOptions">');if(n>-1){const t=e.substring(0,n),s=e.substring(n);e=getRandomElement(t.split("---"))+s}else e=getRandomElement(t)}return e}function processAudio(e){return e=(e=e.replaceAll(/<audio[\s\S]*?src="([^"]+)"[\s\S]*?<\/audio>/gm,function(e,t){if(e.includes("autoplay")){return new Audio(t).play(),`\x3c!--${e}--\x3e`}return e})).replaceAll(/!Audio:(.*)/g,function(e,t){return new Audio(t.trim()).play(),""})}function processKroki(e){return yamlUseAddOns&&yamlUseAddOns.includes("kroki")&&(e=e.replaceAll(/```(mermaid|tikz|graphviz|plantuml|excalidraw|vegalite|vega)((.|\n)*?)```/gm,function(e,t,n){return n=n.replaceAll("\n\n\n","\n\n"),krokiCreateImageFromSource(t,n)})),e}function createChatBot(e){let t={};const n={...Object.fromEntries(new URLSearchParams(document.location.search)),...Object.fromEntries(new URLSearchParams(document.location.hash.replace(/#.*\?/,"")))};for(const[e,s]of Object.entries(n))t["GET"+e]=s;!1===yamlFooter?hideFooter():!0!==yamlFooter&&(footerElement.innerHTML=yamlFooter);const s=e.pop();let r=e.pop();document.getElementById("chatbot-name").textContent=s,document.title=s;let a=null,o=Math.floor(Math.random()*defaultMessage.length),i=[];function l(e,n){const s=document.createElement("div");s.classList.add("message"),s.classList.add(n?"user-message":"bot-message"),nextSelected=void 0,e=processFixedVariables(e),n||(e=processRandomMessage(e)),yamlDynamicContent&&(e=processDynamicVariables(e,t,n)),e=processDirectiveBot(e,s),n||(e=processKroki(e=processDirectiveSelectNext(e=processDirectiveNext(e=processAudio(e)))));let r=markdownToHTML(e);!0===yamlMaths?(r=convertLatexExpressions(r),setTimeout(()=>{displayMessage(r,n,s)},100)):displayMessage(r,n,s),nextSelected&&g(nextSelected)}const u=3,c=5,d=.55;function p(t){if(""!=t)for(let n=0;n<e.length;n++){let s=e[n][0];if(t==(s=yamlObfuscate?btoa(s):s)){let t=e[n][2];const s=e[n][3];t=Array.isArray(t)?t.join("\n\n"):t,a=s,l(t=s?y(t,s):t,!1);break}}else l(r,!1)}let m=[];if(yamlSearchInContent||yamlUseLLM)for(let t=0;t<e.length;t++){const n=e[t][2];let s=Array.isArray(n)?n.join(" ").toLowerCase():n.toLowerCase();const r=createVector(s=e[t][0]+" "+s,t);m.push(r)}let f=[];function h(e){if(e)for(let t=0;t<e.length;t++){const n=createVector(e[t]);f.push(n)}}function g(t){""==nextMessage||nextMessageOnlyIfKeywords||(t=nextMessage);let n,s="";if(yamlUseLLM&&(t=t.replace('<span class="hidden">!useLLM</span>',"!useLLM"),n=t.trim().replace("!useLLM",""),yamlUseLLMinformations)){s=topElements(f.map(e=>cosineSimilarity(n,e)),yamlUseLLMmaxTopElements).map(e=>yamlUseLLMinformations[e[1]]).join("\n")}if(!0===yamldetectBadWords&&filterBadWords&&filterBadWords.check(t))return void l(getRandomElement(badWordsMessage),!1);let r,h,g,v=null,M=0,L=0,x=t.toLowerCase();if(a&&(g=(h=a.map(e=>e[0].toLowerCase())).indexOf(x)),a&&g>-1){p(a[g][1])}else{for(let t=0;t<e.length;t++){const n=e[t][0],s=e[t][1];if(nextMessageOnlyIfKeywords&&n!=nextMessage)continue;nextMessageOnlyIfKeywords&&n==nextMessage&&0==s.length&&(x=nextMessage.toLowerCase());const a=s.concat(n),o=e[t][2];let i=0,l=0;if(yamlSearchInContent){i=i+cosineSimilarity(x,m[t])+.5}for(let e of a){let t=e.toLowerCase();if(x.includes(t)){let e=!1;if(nextMessageOnlyIfKeywords){x=removeAccents(x),t=removeAccents(t);const n=new RegExp(`\\b${t}\\b`);x.match(n)&&(e=!0)}else e=!0;e&&(i+=c,i+=t.length/10)}else x.length>4&&hasLevenshteinDistanceLessThan(x,e,u)&&l++}0!=i||nextMessageOnlyIfKeywords||l>L&&(i++,L=l),i>0&&nextMessageOnlyIfKeywords&&n==nextMessage&&(i+=c),i>M&&(v=o,M=i,r=t)}if(v&&M>d||nextMessageOnlyIfKeywords){v&&nextMessageOnlyIfKeywords&&(lastMessageFromBot="",nextMessage="",nextMessageOnlyIfKeywordsCount=0,nextMessageOnlyIfKeywords=!1);let a=v?Array.isArray(v)?v.join("\n\n"):v:"";const o=v?e[r][0]:"";let i=v?e[r][3]:[];if(selectedResponseWithOptions=nextMessageOnlyIfKeywords&&o!==nextMessage?lastMessageFromBot.includes(messageIfKeywordsNotFound)?lastMessageFromBot:messageIfKeywordsNotFound+lastMessageFromBot:y(a,i),yamlUseLLM&&yamlUseLLMurl&&yamlUseLLMmodel&&yamlUseLLMalways||t.includes("!useLLM"))return void getAnswerFromLLM(n.trim(),a+"\n"+s);l(selectedResponseWithOptions,!1)}else{if(yamlUseLLM&&yamlUseLLMurl&&yamlUseLLMmodel&&yamlUseLLMalways||t.includes("!useLLM"))return void getAnswerFromLLM(n,s);{for(;i.includes(o);)o=Math.floor(Math.random()*defaultMessage.length);i.length>4&&i.shift(),i.push(o);let e=defaultMessage[o];if(yamlUseLLM&&!yamlUseLLMalways&&yamlUseLLMurl&&yamlUseLLMmodel){e=y(e,[["Voir une réponse générée par une IA","!useLLM "+t]])}l(e,!1)}}}}function y(e,n){if(yamlDynamicContent&&Object.keys(t).length>0&&n&&(n=n.filter(e=>{for(const[n,s]of Object.entries(t)){if(!e[3])return!0;if(e[3]&&e[3].includes(`@${n}`))return e[3]===`@${n}==${s}`}})),[e,n]=processDirectiveSelect(e,n),shouldBeRandomized(n)&&(n=randomizeArrayWithFixedElements(n)),n){a=n;let t='\n<ul class="messageOptions">';for(let e=0;e<n.length;e++){const s=n[e],r=s[0];t=t+'<li><a href="#'+s[1]+'">'+r+"</a></li>\n"}e+=t+="</ul>"}else a=null;return e}window.useLLMpromise&&window.useLLMpromise.then(()=>{window.useLLMragContentPromise?window.useLLMragContentPromise.then(()=>{h(yamlUseLLMinformations)}):h(yamlUseLLMinformations)}).catch(e=>{console.error("Erreur d'accès aux données RAG : ",e)}),sendButton.addEventListener("click",()=>{const e=userInput.innerText;if(""!==e.trim())l(e,!0),setTimeout(()=>{g(e),scrollWindow()},100),userInput.innerText="";else{const e=new KeyboardEvent("keypress",{key:"Enter",keyCode:13,which:13});userInput.dispatchEvent(e)}}),document.addEventListener("keypress",e=>{userInput.focus(),"Enter"===e.key?(e.preventDefault(),sendButton.click(),scrollWindow()):userInput.parentElement.parentElement.classList.contains("hideControls")&&e.preventDefault()}),userInput.focus({preventScroll:!0}),userInput.addEventListener("focus",function(){this.classList.remove("placeholder")}),userInput.addEventListener("blur",function(){this.classList.add("placeholder")}),chatContainer.addEventListener("click",e=>(function(e){const t=e.target;if("A"===t.tagName){const n=window.location.href,s=t.getAttribute("href");if(s.startsWith(n)&&window.open(s),s.startsWith("#")){e.preventDefault();let n=t.innerText;const r=yamlObfuscate?atob(s.replace("#","")):s;yamlUseLLM&&yamlUseLLMurl&&yamlUseLLMmodel&&r.includes("!useLLM")?(l(n=r.replace("#","").replace("!useLLM",'<span class="hidden">!useLLM</span>').trim(),!0),g(n)):(l(n,!0),p(s.substring(1)),document.activeElement.blur(),autoFocus&&userInput.focus()),scrollWindow()}}})(e)),r=y(r[0].join("\n"),r[1]),yamlDynamicContent&&(r=processDynamicVariables(r,t,!1)),l(r,!1),r=r.replace(/<span class=\"unique\">.*?<\/span>/,"")}function prepareRAGdata(e,t){if(t){if("auto"==t){return function(e,t=600){let n=[],s=0;for(;s<e.length;){let r=s+t;if(r<e.length){let t=e.lastIndexOf(" ",r);t>s&&(r=t)}n.push(e.slice(s,r).trim()),s=r+1}return n}(e)}return"break"==yamlUseLLM.separator?e.split("---").map(e=>e.replaceAll("\n"," ").trim()):e.split(yamlUseLLM.separator)}return e.split("\n").filter(e=>""!==e.trim())}async function getRAGcontent(e){if(e){if(yamlUseLLMmaxTopElements=yamlUseLLM.maxTopElements?yamlUseLLM.maxTopElements:3,!e.includes("http"))return e.toString().includes("useFile")?(RAGinformations=RAGinformations.trim(),yamlUseLLMinformations=prepareRAGdata(RAGinformations,yamlUseLLM.separator)):(RAGinformations=e.trim(),yamlUseLLMinformations=prepareRAGdata(RAGinformations,yamlUseLLM.separator)),yamlUseLLMinformations;{const t=handleURL(e);yamlUseLLMinformations=await fetch(t).then(e=>e.text()).then(e=>prepareRAGdata(e,yamlUseLLM.separator))}}}function processYAML(e){if(e.split("---").length>2&&e.startsWith("---"))try{(yamlData=jsyaml.load(e.split("---")[1])).maths&&(yamlData.addOns=yamlData.addOns?yamlData.addOns+",textFit":"textFit");for(const e in yamlData){if("maths"==e&&!0===(yamlMaths=yamlData[e])&&Promise.all([loadScript("https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"),loadCSS("https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css")]),"addOns"==e){yamlUseAddOns=yamlData[e].replace(" ","").split(",");let t=[];for(const[e,n]of Object.entries(addOnsDependencies))if(yamlUseAddOns.includes(e))for(const e of n)t.push(e);yamlUseAddOns.push(...t);for(const e of yamlUseAddOns){const t=[],n=allowedAddOns[e];n&&(n.js&&t.push(loadScript(n.js)),n.css&&t.push(loadCSS(n.css)),Promise.all(t))}}if("titresRéponses"!=e&&"responsesTitles"!=e||"string"==typeof(responsesTitles=yamlData[e])&&(responsesTitles=[responsesTitles]),"style"==e){yamlStyle=yamlData[e];const t=document.createElement("style");t.innerHTML=yamlStyle,document.body.appendChild(t)}if("userInput"!=e&&"clavier"!=e&&"keyboard"!=e||!1===(yamlUserInput=yamlData[e])&&document.body.classList.add("hideControls"),"searchInContent"!=e&&"rechercheContenu"!=e||(yamlSearchInContent=yamlData[e]),"gestionGrosMots"!=e&&"detectBadWords"!=e||!0===(yamldetectBadWords=yamlData[e])&&Promise.all([loadScript("externals/leo-profanity.js"),loadScript("externals/badWords-fr.js")]).then(()=>{(filterBadWords=LeoProfanity).add(badWordsFR)}).catch(e=>{console.error("Une erreur s'est produite lors du chargement des scripts :",e)}),"favicon"==e){document.getElementById("favicon").href=yamlData[e]}if("avatar"==e){yamlAvatar=yamlData[e];const t=`\n  \t\t\t\t\t\t.bot-message > :first-child:before {\n        \t\t\t\tbackground-image: url("${yamlAvatar}");\n\t\t\t\t\t`,n=document.createElement("style");n.textContent=t,document.head.appendChild(n)}if("defaultMessage"==e||"messageParDéfaut"==e)for(yamlDefaultMessage=yamlData[e],defaultMessage=yamlDefaultMessage;defaultMessage.length<5;)defaultMessage.push(...defaultMessage);if("footer"==e&&!0===(yamlFooter=yamlData[e])&&document.body.classList.add("hideFooter"),"theme"==e){loadCSS((yamlTheme=yamlData[e]).endsWith(".css")?"themes/"+yamlTheme:"themes/"+yamlTheme+".css")}if("dynamicContent"!=e&&"contenuDynamique"!=e||(yamlDynamicContent=yamlData[e]),"typeWriter"!=e&&"effetDactylo"!=e||(yamlTypeWriter=yamlData[e]),"obfuscate"==e&&(yamlObfuscate=!!yamlData[e]),"bots"==e){yamlBots=yamlData[e];for(const[e,t]of Object.entries(yamlBots)){const n="<style>"+(".botName-"+e+">:first-child:before {"+(t.avatar?'background-image:url("'+t.avatar+'"); ':"")+(t.cssAvatar?t.cssAvatar:"")+"}")+" .botName-"+e+"{"+(t.cssMessage?t.cssMessage:"")+"}</style>";Promise.all([loadCSS(n)])}}"useLLM"!=e&&"utiliserLLM"!=e||(window.useLLMpromise=Promise.all([loadScript("LLM/useLLM.js"),loadScript("LLM/RAG.js")]).then(()=>{window.useLLMragContentPromise=new Promise((e,t)=>{try{e(getRAGcontent(yamlUseLLM.informations))}catch(e){t(e)}})}).catch(e=>console.error(e)),yamlUseLLM=yamlData[e],yamlUseLLMurl=yamlUseLLM.url,yamlUseLLMapiKey=!0===yamlUseLLM.askAPIkey?prompt("Ce chatbot peut se connecter à une IA pour enrichir les réponses proposées. Entrez votre clé API, puis cliquez sur “OK” pour pouvoir bénéficier de cette fonctionnalité. Sinon, cliquez sur “Annuler”."):yamlUseLLM.askAPIkey?yamlUseLLM.askAPIkey:"",yamlUseLLMmodel=yamlUseLLM.model,yamlUseLLMalways=yamlUseLLM.always,yamlUseLLMsystemPrompt=yamlUseLLM.systemPrompt?yamlUseLLM.systemPrompt:defaultSystemPrompt,yamlUseLLMpostprompt=yamlUseLLM.postprompt?yamlUseLLM.postprompt:defaultPostprompt,yamlUseLLMpreprompt=yamlUseLLM.preprompt?yamlUseLLM.preprompt:"",yamlUseLLMmaxTokens=yamlUseLLM.maxTokens?yamlUseLLM.maxTokens:defaultMaxTokens)}}catch(e){}}const controls=document.getElementById("controls");function getMarkdownContent(){const e=window.location.hash.substring(1).replace(/\?.*/,"");if(""!==e){const t=handleURL(e);if(Array.isArray(t)){const e=t.map(e=>fetch(e).then(e=>e.text()));Promise.all(e).then(e=>{md=e.join("\n"),createChatBot(chatData=parseMarkdown(md))}).catch(e=>console.error(e))}else fetch(t).then(e=>e.text()).then(e=>{createChatBot(chatData=parseMarkdown(md=e))}).catch(e=>console.error(e))}else createChatBot(parseMarkdown(md))}function parseMarkdown(e){processYAML(e);let t=[],n=null,s=[],r=[],a=null;const o=/^\d{1,3}(\.|\))\s\[/,i=/^\d{1,3}\)/,l=/\`if (.*?)\`/;let u=!1,c=[],d=[],p=!1,m=e.indexOf("# ");const f=e.indexOf("## ");f>-1&&f==m-1&&(m=0);let h=e.substring(m);yamlData&&yamlData.variables&&(h=processFixedVariables(h,!0));const g=h.substring(1),y=["# ","## ","### ","#### ","##### "].map(e=>g.indexOf(e)).filter(e=>e>0),v=Math.min(...y),M=h.substring(0,v),L=M.match(/# .*/),x=L?L[0]:"Chatbot",b=x?[x.replace("# ","").trim()]:[""],A=M.indexOf(x),w=(L?M.substring(A+x.length):M.substring(A)).split("\n");for(let e of w)if((e=e.replace(/^>\s?/,"").trim()).match(o)){p=i.test(e);const t=e.replace(/^\d+(\.|\))\s/,"").trim();let n=t.replace(/^\[.*?\]\(/,"").replace(/\)$/,"");n=yamlObfuscate?btoa(n):n;const s=t.replace(/\]\(.*/,"").replace(/^\[/,"");d.push([s,n,p])}else c.push(e);const C=h.substring(v).split("\n");let q="";for(let e of C)if(startsWithAnyOf(e,responsesTitles))n&&t.push([n,s,r,a]),n=e.replace(startsWithAnyOf(e,responsesTitles),"").trim(),s=[],a=null,u=!1,r=[];else if(e.startsWith("- ")&&!u)s.push(e.replace("- ","").trim());else if(yamlDynamicContent&&e.match(l))q=e.match(l)[1]?e.match(l)[1]:"",r.push(e+"\n"),u=!0;else if(yamlDynamicContent&&e.match("`endif`"))q="",r.push(e+"\n"),u=!0;else if(e.match(o)){u=!1,a||(a=[]),p=i.test(e);const t=e.replace(/^\d+(\.|\))\s/,"").trim();let n=t.replace(/^\[.*?\]\(/,"").replace(/\)$/,"");n=yamlObfuscate?btoa(n):n;const s=t.replace(/\]\(.*/,"").replace(/^\[/,"");a.push([s,n,p,q])}else e.length>0&&!e.startsWith("# ")&&(e=e.replaceAll(/\[(.*?)\]\((#.*?)\)/g,'<a href="$2">$1</a>'),r.push(e),u=!0);t.push([n,s,r,a]);const O=[c,d];return t.push(O),t.push(b),t}getMarkdownContent();